<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentic Therapy AI - Mental Health Support</title>
    <style>
        :root {
            --primary-black: #000000;
            --primary-dark: #1a1a1a;
            --primary-gray-dark: #2d2d2d;
            --primary-gray: #404040;
            --text-inverse: #ffffff;
            --bg-lighter: #ffffff;
            --bg-light: #f5f5f5;
            --border-light: #cccccc;
            --border-lighter: #e6e6e6;
            --gradient-dark: linear-gradient(135deg, #000000 0%, #2d2d2d 100%);
            --gradient-medium: linear-gradient(135deg, #1a1a1a 0%, #404040 100%);
            --gradient-light: linear-gradient(135deg, #f5f5f5 0%, #ffffff 100%);
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 20px 40px rgba(0, 0, 0, 0.2);
            --shadow-dark: 0 8px 16px rgba(0, 0, 0, 0.3);
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 18px;
            --radius-xxl: 20px;
            --radius-round: 25px;
            --radius-circle: 50%;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: var(--gradient-dark);
            height: 100vh;
            width: 100vw;
            color: #000;
            line-height: 1.6;
            overflow: hidden;
        }

        .privacy-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            display: flex !important;
            align-items: center;
            justify-content: center;
            z-index: 999999;
            /* Removed backdrop-filter for Chrome compatibility */
            padding: 20px;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .privacy-modal {
            background: white;
            padding: 40px;
            border-radius: var(--radius-xxl);
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            text-align: center;
            box-shadow: var(--shadow-heavy);
            border: 3px solid black;
        }

        .privacy-modal h2 {
            color: black;
            margin-bottom: 20px;
            font-size: 1.6em;
        }

        .consent-content {
            text-align: left;
            margin: 20px 0;
            padding: 20px;
            background: #f5f5f5;
            border-radius: var(--radius-lg);
            font-size: 0.9em;
            line-height: 1.8;
            border: 2px solid #ccc;
        }

        .consent-content h4 {
            color: #404040;
            margin-bottom: 10px;
        }

        .consent-content ul {
            padding-left: 20px;
        }

        .consent-content li {
            margin-bottom: 8px;
        }

        .privacy-options {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }

        .privacy-option {
            flex: 1;
            padding: 20px;
            border: 2px solid #ccc;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .privacy-option:hover {
            border-color: black;
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .privacy-option.selected {
            border-color: black;
            background: #f5f5f5;
        }

        .privacy-option h4 {
            margin-bottom: 10px;
            color: black;
        }

        .privacy-option p {
            font-size: 0.8em;
            color: #404040;
        }

        .retention-selector {
            margin-top: 15px;
            display: none;
        }

        .retention-selector.show {
            display: block;
        }

        .user-credentials {
            margin: 20px 0;
            display: none;
        }

        .user-credentials.show {
            display: block;
        }

        .credential-field {
            padding: 12px;
            border: 2px solid #ccc;
            border-radius: var(--radius-lg);
            width: 100%;
            margin: 10px 0;
            font-size: 1em;
        }

        .credential-field:focus {
            outline: none;
            border-color: black;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .consent-button {
            background: var(--gradient-dark);
            color: white;
            border: 2px solid black;
            padding: 12px 30px;
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            max-width: 300px;
            margin: 10px;
        }

        .consent-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-dark);
        }

        .consent-button:disabled {
            background: #ccc;
            color: #666;
            cursor: not-allowed;
            transform: none;
        }

        .select-field {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #ccc;
            border-radius: var(--radius-md);
            background: white;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .container {
            display: flex;
            height: 100vh;
            width: 100vw;
            background: rgba(255, 255, 255, 0.98);
            overflow: hidden;
        }

        .sidebar {
            width: 350px;
            min-width: 320px;
            background: var(--gradient-light);
            border-right: 2px solid #ccc;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 20px;
            background: var(--gradient-dark);
            color: white;
            text-align: center;
        }

        .sidebar-header h1 {
            font-size: 1.3em;
            margin-bottom: 5px;
        }

        .agentic-indicator {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            font-size: 0.8em;
        }

        .sidebar-content {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .section {
            margin-bottom: 25px;
            background: white;
            border-radius: var(--radius-lg);
            padding: 15px;
            box-shadow: var(--shadow-light);
            border: 2px solid #e6e6e6;
        }

        .section h3 {
            margin-bottom: 15px;
            color: #404040;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .section.collapsed .section-content {
            display: none;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .collapse-icon {
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }

        .section.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .button-sidebar {
            width: 100%;
            padding: 10px 20px;
            background: var(--gradient-dark);
            color: white;
            border: 2px solid black;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .button-sidebar:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .button-sidebar:disabled {
            background: #ccc;
            color: #666;
            cursor: not-allowed;
            transform: none;
            border-color: #ccc;
        }

        .button-icon {
            margin-right: 8px;
            font-size: 1.1em;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .button-group .button-sidebar {
            flex: 1;
            margin-bottom: 0;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active {
            background: #4ade80;
            box-shadow: 0 0 8px rgba(74, 222, 128, 0.5);
        }

        .status-inactive {
            background: #ccc;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e6e6e6;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-dark);
            transition: width 0.3s ease;
        }

        .metric-card {
            background: #f5f5f5;
            padding: 12px;
            border-radius: var(--radius-md);
            margin-bottom: 10px;
            border: 2px solid #e6e6e6;
        }

        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: black;
        }

        .metric-label {
            font-size: 0.8em;
            color: #666;
            margin-top: 4px;
        }

        .goal-item {
            background: white;
            padding: 12px;
            border-radius: var(--radius-md);
            margin-bottom: 10px;
            border: 2px solid #e6e6e6;
        }

        .goal-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #404040;
        }

        .goal-description {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 8px;
        }

        .goal-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85em;
        }

        .crisis-panel {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: var(--radius-lg);
            padding: 15px;
            margin-bottom: 15px;
        }

        .crisis-panel h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .crisis-resource {
            background: white;
            padding: 10px;
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            border-left: 4px solid #ffc107;
        }

        .crisis-resource strong {
            color: #856404;
        }

        .coping-strategy {
            background: #f5f5f5;
            padding: 10px;
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            border-left: 4px solid #404040;
            font-size: 0.9em;
        }

        .emotion-trend {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            background: #f5f5f5;
            border-radius: var(--radius-md);
            margin-bottom: 8px;
        }

        .emotion-icon {
            font-size: 1.5em;
        }

        .emotion-data {
            flex: 1;
            margin-left: 10px;
        }

        .emotion-name {
            font-weight: 600;
            font-size: 0.9em;
        }

        .emotion-percentage {
            font-size: 0.8em;
            color: #666;
        }

        .tab-container {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid #e6e6e6;
        }

        .tab {
            padding: 8px 16px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab:hover {
            color: #404040;
        }

        .tab.active {
            color: black;
            border-bottom-color: black;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 5px;
            color: #404040;
        }

        .input-field {
            width: 100%;
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: var(--radius-md);
            font-size: 0.9em;
        }

        .input-field:focus {
            outline: none;
            border-color: black;
        }

        textarea.input-field {
            resize: vertical;
            min-height: 80px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: var(--radius-xl);
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.3em;
            font-weight: bold;
            color: black;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .modal-close:hover {
            color: black;
        }

        .voice-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .voice-button {
            padding: 10px 20px;
            border-radius: var(--radius-round);
            border: 2px solid black;
            background: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .voice-button:hover {
            background: black;
            color: white;
        }

        .voice-button.active {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .feedback-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .feedback-btn {
            padding: 6px 12px;
            border: 2px solid #ccc;
            border-radius: var(--radius-md);
            background: white;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s ease;
        }

        .feedback-btn:hover {
            border-color: black;
        }

        .feedback-btn.positive {
            border-color: #4ade80;
            color: #16a34a;
        }

        .feedback-btn.negative {
            border-color: #f87171;
            color: #dc2626;
        }

        .settings-panel {
            background: #f5f5f5;
            padding: 15px;
            border-radius: var(--radius-lg);
            margin-bottom: 15px;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e6e6e6;
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        /* Credentials Modal Styles */
        .credentials-modal {
            max-width: 420px;
        }

        .credentials-container {
            background: #000;
            padding: 20px;
            border-radius: 4px;
            color: white;
            margin-bottom: 15px;
            border: 1px solid #333;
        }

        .credentials-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }

        .credentials-header h3 {
            margin: 0;
            font-size: 1.1em;
            color: white;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .credentials-header p {
            margin: 8px 0 0 0;
            color: #999;
            font-size: 0.85em;
        }

        .credential-item {
            background: #111;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 12px;
            border: 1px solid #333;
        }

        .credential-label {
            font-size: 0.75em;
            color: #999;
            margin-bottom: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .credential-value-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .credential-value {
            flex: 1;
            background: #000;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: white;
            word-break: break-all;
            border: 1px solid #444;
        }

        .copy-btn {
            background: white;
            color: black;
            border: 1px solid white;
            padding: 8px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8em;
            transition: all 0.2s ease;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .copy-btn:hover {
            background: #f0f0f0;
            transform: scale(1.02);
        }

        .copy-btn:active {
            transform: scale(0.98);
        }

        .copy-btn.copied {
            background: black;
            color: white;
            border-color: white;
        }

        .credentials-warning {
            background: #1a1a1a;
            border: 1px solid #444;
            padding: 12px;
            border-radius: 4px;
            margin-top: 15px;
            text-align: center;
            font-size: 0.85em;
        }

        .credentials-warning strong {
            display: block;
            margin-bottom: 6px;
            font-size: 0.9em;
            color: white;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .credentials-warning p {
            color: #999;
            line-height: 1.4;
        }

        .credentials-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .credentials-actions button {
            flex: 1;
            padding: 10px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-download {
            background: white;
            color: black;
            border: 1px solid white;
        }

        .btn-download:hover {
            background: #f0f0f0;
            transform: scale(1.02);
        }

        .btn-continue {
            background: black;
            color: white;
            border: 1px solid white;
        }

        .btn-continue:hover {
            background: #1a1a1a;
            transform: scale(1.02);
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: black;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .multimodal-controls {
            display: flex;
            gap: 15px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: var(--radius-md);
            margin-bottom: 10px;
        }

        .multimodal-toggle {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-size: 0.85em;
            user-select: none;
        }

        .multimodal-toggle input[type="checkbox"] {
            cursor: pointer;
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        #quickVoiceBtn {
            padding: 10px 15px;
            background: white;
            border: 2px solid #ccc;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        #quickVoiceBtn:hover {
            border-color: black;
            transform: translateY(-1px);
        }

        #quickVoiceBtn.active {
            background: #dc2626;
            border-color: #dc2626;
            color: white;
            animation: pulse 1.5s infinite;
        }

        .analysis-panel {
            background: #f5f5f5;
            border: 2px solid #e6e6e6;
            border-radius: var(--radius-md);
            padding: 12px;
            margin-top: 10px;
        }

        .analysis-metrics {
            display: flex;
            gap: 15px;
            justify-content: space-around;
        }

        .analysis-metrics .metric {
            flex: 1;
            text-align: center;
        }

        .analysis-metrics .metric-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #404040;
            text-transform: capitalize;
        }

        .analysis-metrics .metric-label {
            font-size: 0.75em;
            color: #666;
            text-transform: uppercase;
            margin-top: 4px;
        }

        .crisis-alert {
            background: #fee2e2;
            border: 2px solid #dc2626;
            border-radius: var(--radius-lg);
            padding: 20px;
            margin: 15px 0;
            color: #7f1d1d;
            line-height: 1.8;
        }

        .crisis-alert strong {
            color: #dc2626;
        }

        .video-analysis-panel {
            background: #f5f5f5;
            border: 2px solid #e6e6e6;
            border-radius: var(--radius-md);
            padding: 12px;
            margin-top: 10px;
        }

        small {
            font-size: 0.85em;
        }

        .video-stream-container {
            margin: 10px 0;
            text-align: center;
            background: white;
            padding: 10px;
            border-radius: var(--radius-md);
            border: 2px solid #ccc;
        }

        .video-emotion-display {
            background: #f5f5f5;
            padding: 15px;
            border-radius: var(--radius-md);
            margin: 10px 0;
            text-align: center;
            border: 2px solid #ccc;
        }

        .emotion-indicator {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            min-width: 0;
        }

        .chat-header {
            padding: 20px;
            background: var(--gradient-medium);
            color: white;
            text-align: center;
        }

        .chat-header h2 {
            font-size: 1.4em;
            margin-bottom: 5px;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);
            scroll-behavior: smooth;
            min-height: 0;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: flex-start;
            max-width: 100%;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-content {
            max-width: 75%;
            padding: 15px 20px;
            border-radius: 18px;
            word-wrap: break-word;
            box-shadow: var(--shadow-light);
        }

        .message.user .message-content {
            background: var(--gradient-dark);
            color: white;
            border-bottom-right-radius: 6px;
            border: 2px solid black;
        }

        .message.assistant .message-content {
            background: white;
            border: 2px solid #ccc;
            border-bottom-left-radius: 6px;
            color: black;
        }

        .message-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            font-size: 0.8em;
            flex-shrink: 0;
            border: 2px solid black;
        }

        .message.user .message-avatar {
            background: var(--gradient-dark);
        }

        .message.assistant .message-avatar {
            background: var(--gradient-medium);
        }

        .message-meta {
            font-size: 0.7em;
            margin-top: 10px;
            opacity: 0.7;
        }

        .analysis-panel {
            background: #f5f5f5;
            border: 2px solid #ccc;
            border-radius: var(--radius-lg);
            padding: 15px;
            margin-top: 15px;
            font-size: 0.8em;
        }

        .analysis-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .metric {
            background: white;
            padding: 15px;
            border-radius: var(--radius-md);
            text-align: center;
            box-shadow: var(--shadow-light);
            border: 2px solid #e6e6e6;
        }

        .metric-value {
            font-size: 1.2em;
            font-weight: 600;
            color: black;
            margin-bottom: 4px;
        }

        .metric-label {
            font-size: 0.8em;
            color: #666;
            text-transform: uppercase;
        }

        .input-area {
            padding: 20px;
            background: white;
            border-top: 2px solid #ccc;
        }

        .multimodal-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .multimodal-toggle {
            padding: 10px;
            background: white;
            border: 2px solid #ccc;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .multimodal-toggle:hover {
            border-color: black;
        }

        .multimodal-toggle.active {
            background: #f5f5f5;
            border-color: black;
            font-weight: 600;
        }

        .input-container {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .input-field {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #ccc;
            border-radius: 25px;
            font-size: 1em;
            resize: none;
            max-height: 120px;
            min-height: 50px;
            font-family: inherit;
            line-height: 1.4;
        }

        .input-field:focus {
            outline: none;
            border-color: black;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .send-button {
            padding: 15px 30px;
            background: var(--gradient-dark);
            color: white;
            border: 2px solid black;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-dark);
        }

        .send-button:disabled {
            background: #ccc;
            color: #666;
            cursor: not-allowed;
            transform: none;
            border-color: #ccc;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #ccc;
            border-top: 4px solid black;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .crisis-alert {
            background: var(--gradient-dark);
            color: white;
            padding: 20px;
            border-radius: var(--radius-lg);
            margin: 15px 0;
            font-weight: 500;
            animation: pulse 2s infinite;
            box-shadow: var(--shadow-dark);
            border: 2px solid black;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                max-height: 300px;
            }
            .message-content {
                max-width: 85%;
            }
            .privacy-options {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="privacyOverlay" class="privacy-overlay">
        <div class="privacy-modal">
            <h2>üß† Agentic Therapy AI</h2>
            <p><strong>Advanced Mental Health Support System</strong></p>
            <div class="consent-content">
                <h4>üìã Choose Your Experience:</h4>
                <ul>
                    <li><strong>Private Sessions:</strong> Standard support, no memory between sessions</li>
                    <li><strong>Agentic Mode:</strong> Remembers conversations, tracks goals, provides personalized insights</li>
                </ul>
                <h4>üîí Privacy & Security:</h4>
                <ul>
                    <li>All data stays on your device (local storage only)</li>
                    <li>Encrypted with your personal password</li>
                    <li>Delete your data anytime</li>
                    <li>You control data retention period</li>
                </ul>
                <h4>‚ö†Ô∏è Important:</h4>
                <ul>
                    <li>This is an AI assistant, not a licensed therapist</li>
                    <li>For emergencies: Call 112 or KIRAN helpline 1800-599-0019</li>
                    <li>Crisis resources available 24/7</li>
                </ul>
            </div>
            <div class="privacy-options">
                <div class="privacy-option" id="privateOption">
                    <h4>üîì Private Sessions</h4>
                    <p>Each session is independent. No data stored. Maximum privacy.</p>
                </div>
                <div class="privacy-option" id="agenticOption">
                    <h4>ü§ñ Agentic Mode</h4>
                    <p>Personalized support with memory, goals, and progress tracking.</p>
                    <div class="retention-selector" id="retentionSelector">
                        <label for="retentionDays">Keep data for:</label>
                        <select id="retentionDays" class="select-field">
                            <option value="7">1 Week</option>
                            <option value="30" selected>1 Month</option>
                            <option value="90">3 Months</option>
                            <option value="365">1 Year</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="user-credentials" id="userCredentials">
                <h4>üîê Setup Your Secure Account</h4>
                <input type="text" id="preferredName" class="credential-field" placeholder="Your name (e.g., Alex)">
                <input type="password" id="userPassword" class="credential-field" placeholder="Create a secure password">
                <small style="color: #666;">Your password encrypts all data locally. Keep it safe!</small>
            </div>
            <div class="user-credentials" id="returningUser">
                <h4>üëã Welcome Back!</h4>
                <input type="text" id="returningUserId" class="credential-field" placeholder="Your User ID">
                <input type="password" id="returningPassword" class="credential-field" placeholder="Your Password">
                <button class="consent-button" id="loginButton">Sign In</button>
            </div>
            <div>
                <button class="consent-button" id="proceedButton" disabled>Begin Session</button>
                <button class="consent-button" id="returningUserButton">Returning User</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>Agentic Therapy AI</h1>
                <p>Mental Health Support</p>
                <div id="sessionInfo">
                    <small>Session: <span id="sessionId">Loading...</span></small>
                    <div class="agentic-indicator">
                        <span id="modeIndicator">Initializing...</span>
                    </div>
                </div>
            </div>
            <div class="sidebar-content">
                <!-- Voice Features -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection('voice')">
                        <h3><span class="button-icon">üé§</span>Voice Features</h3>
                        <span class="collapse-icon">‚ñº</span>
                    </div>
                    <div class="section-content" id="voice-section">
                        <div class="button-group">
                            <button class="button-sidebar" id="voiceInputBtn">
                                <span class="button-icon">üéôÔ∏è</span>Speak
                            </button>
                            <button class="button-sidebar" id="voiceOutputBtn">
                                <span class="button-icon">üîä</span>Listen
                            </button>
                        </div>
                        <div class="setting-row">
                            <span>Auto-speak responses</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="autoSpeakToggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <small style="display: block; margin-top: 10px; color: #666;">
                            <span class="status-indicator" id="voiceStatus"></span>
                            <span id="voiceStatusText">Voice ready</span>
                        </small>
                    </div>
                </div>

                <!-- Video Features -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection('video')">
                        <h3><span class="button-icon">üìπ</span>Video Features</h3>
                        <span class="collapse-icon">‚ñº</span>
                    </div>
                    <div class="section-content" id="video-section">
                        <div class="button-group">
                            <button class="button-sidebar" id="videoToggleBtn" disabled>
                                <span class="button-icon">üìπ</span>Enable Video
                            </button>
                            <button class="button-sidebar" id="analyzeVideoBtn" disabled>
                                <span class="button-icon">üîç</span>Analyze
                            </button>
                        </div>
                        <div class="setting-row">
                            <span>Continuous monitoring</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="continuousMonitorToggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="video-stream-container" id="videoStreamContainer" style="display: none; margin-top: 10px;">
                            <video id="videoStream" width="100%" height="auto" autoplay muted playsinline
                                   style="border: 2px solid #4CAF50; border-radius: 8px; background: #000; min-height: 180px; max-width: 100%; object-fit: cover;"></video>
                        </div>
                        <div class="video-emotion-display" id="videoEmotionDisplay" style="display: none; margin-top: 10px;">
                            <div style="text-align: center;">
                                <span id="emotionEmoji" style="font-size: 2em;">üòê</span>
                                <div style="margin-top: 5px;">
                                    <span id="emotionText" style="font-weight: 600;">Neutral</span>
                                    <small style="display: block; color: #666;">
                                        Confidence: <span id="emotionConfidence">0%</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div id="emotionTrendsContainer" style="display: none; margin-top: 10px;">
                            <h4 style="font-size: 0.85em; margin-bottom: 8px;">Recent Emotions:</h4>
                            <div id="emotionTrends"></div>
                        </div>
                        <small id="videoInstructions" style="display: block; margin-top: 10px; color: #666;">
                            Enable video for facial expression analysis
                        </small>
                    </div>
                </div>

                <!-- Goals -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection('goals')">
                        <h3><span class="button-icon">üéØ</span>My Goals</h3>
                        <span class="collapse-icon">‚ñº</span>
                    </div>
                    <div class="section-content" id="goals-section">
                        <button class="button-sidebar" id="createGoalBtn">
                            <span class="button-icon">‚ûï</span>Create New Goal
                        </button>
                        <div id="goalsListContainer" style="margin-top: 15px;">
                            <div id="goalsList"></div>
                            <small style="color: #666; display: block; text-align: center; margin-top: 10px;">
                                No goals yet. Create one to track your progress!
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Crisis Resources -->
                <div class="section" style="background: #fff3cd; border-color: #ffc107;">
                    <div class="section-header" onclick="toggleSection('crisis')">
                        <h3 style="color: #856404;"><span class="button-icon">üÜò</span>Crisis Resources</h3>
                        <span class="collapse-icon">‚ñº</span>
                    </div>
                    <div class="section-content" id="crisis-section">
                        <div class="crisis-resource">
                            <strong>1800-599-0019</strong> - KIRAN Mental Health<br>
                            <small>24/7 phone support</small>
                        </div>
                        <div class="crisis-resource">
                            <strong>9152987821</strong> - Vandrevala Foundation<br>
                            <small>24/7 crisis helpline</small>
                        </div>
                        <div class="crisis-resource">
                            <strong>112</strong> - Emergency Services<br>
                            <small>Immediate danger</small>
                        </div>
                        <button class="button-sidebar" id="copingStrategiesBtn" style="margin-top: 10px;">
                            <span class="button-icon">üí°</span>Coping Strategies
                        </button>
                    </div>
                </div>

                <!-- Dashboard -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection('dashboard')">
                        <h3><span class="button-icon">üìä</span>Dashboard</h3>
                        <span class="collapse-icon">‚ñº</span>
                    </div>
                    <div class="section-content" id="dashboard-section">
                        <div class="metric-card">
                            <div class="metric-value" id="sessionDuration">0m</div>
                            <div class="metric-label">Session Duration</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="messageCount">0</div>
                            <div class="metric-label">Messages Exchanged</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="emotionSummary">üòê Neutral</div>
                            <div class="metric-label">Primary Emotion</div>
                        </div>
                        <button class="button-sidebar" id="viewFullDashboardBtn" disabled>
                            <span class="button-icon">üìà</span>View Full Analytics
                        </button>
                    </div>
                </div>

                <!-- Settings -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection('settings')">
                        <h3><span class="button-icon">‚öôÔ∏è</span>Settings</h3>
                        <span class="collapse-icon">‚ñº</span>
                    </div>
                    <div class="section-content" id="settings-section">
                        <button class="button-sidebar" id="accountSettingsBtn" disabled>
                            <span class="button-icon">üë§</span>Account Settings
                        </button>
                        <button class="button-sidebar" id="resetSession">
                            <span class="button-icon">üîÑ</span>New Session
                        </button>
                        <div class="setting-row">
                            <span>Crisis Detection</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="crisisDetectionToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-area">
            <div class="chat-header">
                <h2>üí¨ Therapy Chat Session</h2>
                <p>Share what's on your mind - I'm here to support you</p>
            </div>
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="loading" id="loadingIndicator">
                    <div class="spinner"></div>
                    <p>Thinking...</p>
                </div>
                <div class="input-area">
                    <div class="multimodal-controls">
                        <label class="multimodal-toggle">
                            <input type="checkbox" id="includeVideo">
                            <span>üìπ Video</span>
                        </label>
                        <label class="multimodal-toggle">
                            <input type="checkbox" id="includeVoice">
                            <span>üé§ Voice</span>
                        </label>
                        <label class="multimodal-toggle">
                            <input type="checkbox" id="useMultimodal">
                            <span>üîÄ Multimodal</span>
                        </label>
                    </div>
                    <div class="input-container">
                        <button id="quickVoiceBtn" class="voice-button" title="Quick voice input">
                            üéôÔ∏è
                        </button>
                        <textarea id="messageInput" class="input-field" 
                                  placeholder="Share your thoughts and feelings..." rows="1"></textarea>
                        <button id="sendButton" class="send-button">
                            <span>Send</span>
                            <span>‚û§</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Goal Modal -->
    <div class="modal-overlay" id="createGoalModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">üéØ Create New Goal</h3>
                <button class="modal-close" onclick="closeModal('createGoalModal')">‚úï</button>
            </div>
            <div class="input-group">
                <label for="goalTitle">Goal Title</label>
                <input type="text" id="goalTitle" class="input-field" placeholder="E.g., Manage anxiety better">
            </div>
            <div class="input-group">
                <label for="goalDescription">Description</label>
                <textarea id="goalDescription" class="input-field" placeholder="What would success look like?"></textarea>
            </div>
            <div class="input-group">
                <label for="goalCategory">Category</label>
                <select id="goalCategory" class="input-field">
                    <option value="anxiety">Anxiety Management</option>
                    <option value="depression">Depression Relief</option>
                    <option value="relationships">Relationships</option>
                    <option value="self_care">Self-Care</option>
                    <option value="stress">Stress Management</option>
                    <option value="grief">Grief Processing</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="input-group">
                <label for="goalTarget">Target Date (Optional)</label>
                <input type="date" id="goalTarget" class="input-field">
            </div>
            <button class="button-sidebar" onclick="createGoal()">
                <span class="button-icon">‚úì</span>Create Goal
            </button>
        </div>
    </div>

    <!-- Coping Strategies Modal -->
    <div class="modal-overlay" id="copingStrategiesModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">üí° Coping Strategies</h3>
                <button class="modal-close" onclick="closeModal('copingStrategiesModal')">‚úï</button>
            </div>
            <div class="tab-container">
                <button class="tab active" onclick="showCopingTab('immediate')">Immediate</button>
                <button class="tab" onclick="showCopingTab('shortTerm')">Short-term</button>
                <button class="tab" onclick="showCopingTab('longTerm')">Long-term</button>
            </div>
            <div class="tab-content active" id="immediate-coping">
                <h4 style="margin-bottom: 10px;">Right Now Strategies:</h4>
                <div id="immediateStrategiesList">
                    <div class="coping-strategy">Loading strategies...</div>
                </div>
            </div>
            <div class="tab-content" id="shortTerm-coping">
                <h4 style="margin-bottom: 10px;">This Week Strategies:</h4>
                <div id="shortTermStrategiesList">
                    <div class="coping-strategy">Loading strategies...</div>
                </div>
            </div>
            <div class="tab-content" id="longTerm-coping">
                <h4 style="margin-bottom: 10px;">Long-term Healing:</h4>
                <div id="longTermStrategiesList">
                    <div class="coping-strategy">Loading strategies...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Settings Modal -->
    <div class="modal-overlay" id="accountSettingsModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">üë§ Account Settings</h3>
                <button class="modal-close" onclick="closeModal('accountSettingsModal')">‚úï</button>
            </div>
            <div class="settings-panel">
                <div class="setting-row">
                    <div>
                        <strong>User ID</strong><br>
                        <small id="displayUserId">Not logged in</small>
                    </div>
                </div>
                <div class="setting-row">
                    <div>
                        <strong>Agentic Mode</strong><br>
                        <small id="displayAgenticMode">Private Session</small>
                    </div>
                </div>
                <div class="setting-row">
                    <div>
                        <strong>Data Retention</strong><br>
                        <small id="displayRetention">Session only</small>
                    </div>
                </div>
            </div>
            <button class="button-sidebar" id="exportDataBtn" disabled>
                <span class="button-icon">üì•</span>Export My Data
            </button>
            <button class="button-sidebar" id="deleteAccountBtn" disabled style="background: #dc2626; border-color: #dc2626;">
                <span class="button-icon">üóëÔ∏è</span>Delete Account & Data
            </button>
        </div>
    </div>

    <!-- Full Dashboard Modal -->
    <div class="modal-overlay" id="fullDashboardModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">üìä Full Analytics Dashboard</h3>
                <button class="modal-close" onclick="closeModal('fullDashboardModal')">‚úï</button>
            </div>
            <div id="dashboardContent">
                <div class="metric-card">
                    <div class="metric-label">Total Sessions</div>
                    <div class="metric-value" id="totalSessions">0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Goals Achieved</div>
                    <div class="metric-value" id="goalsAchieved">0</div>
                </div>
                <h4 style="margin: 20px 0 10px;">Emotion History:</h4>
                <div id="emotionHistoryChart"></div>
                <h4 style="margin: 20px 0 10px;">Recent Insights:</h4>
                <div id="therapeuticInsights">
                    <small style="color: #666;">Continue using the system to generate insights</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Credentials Modal -->
    <div class="modal-overlay" id="credentialsModal">
        <div class="modal credentials-modal">
            <div class="modal-header" style="border-bottom: 1px solid #333; padding-bottom: 15px;">
                <h3 class="modal-title" style="font-size: 1.1em; font-weight: 600;">Account Created</h3>
                <button class="modal-close" onclick="closeCredentialsModal()">‚úï</button>
            </div>
            <div class="credentials-container">
                <div class="credentials-header">
                    <h3>Your Secure Credentials</h3>
                    <p>Save these credentials to access your account</p>
                </div>
                
                <div class="credential-item">
                    <div class="credential-label">User ID</div>
                    <div class="credential-value-container">
                        <div class="credential-value" id="displayUserId">-</div>
                        <button class="copy-btn" onclick="copyToClipboard('userId')">
                            Copy
                        </button>
                    </div>
                </div>

                <div class="credential-item">
                    <div class="credential-label">Password</div>
                    <div class="credential-value-container">
                        <div class="credential-value" id="displayPassword">-</div>
                        <button class="copy-btn" onclick="copyToClipboard('password')">
                            Copy
                        </button>
                    </div>
                </div>

                <div class="credentials-warning">
                    <strong>Important</strong>
                    <p style="margin: 5px 0 0 0;">Store these credentials safely. You'll need them to log in again.</p>
                </div>
            </div>

            <div class="credentials-actions">
                <button class="btn-download" onclick="downloadCredentials()">
                    Download
                </button>
                <button class="btn-continue" onclick="closeCredentialsModal()">
                    Continue
                </button>
            </div>
        </div>
    </div>

    <script>
        let appState = {
            sessionId: null,
            chatHistory: [],
            settings: {crisis_sensitivity: 'medium', analysis_depth: 'standard'},
            sessionStartTime: null,
            agenticMode: false,
            userId: null,
            consentCompleted: false,
            videoEnabled: false,
            videoAvailable: false,
            voiceEnabled: false,
            isListening: false,
            isSpeaking: false,
            autoSpeak: false,
            continuousMonitoring: false,
            emotionHistory: [],
            currentGoals: [],
            copingStrategiesCache: null
        };

        document.addEventListener('DOMContentLoaded', initializeApp);

        async function initializeApp() {
            try {
                disableChatInterface();
                setupEventListeners();
                await createNewSession();
                await checkProviderStatus();
                await initializeVideoSystem();
            } catch (error) {
                console.error('Init failed:', error);
            }
        }

        function setupEventListeners() {
            console.log('üîß Setting up event listeners...');
            const privateOption = document.getElementById('privateOption');
            const agenticOption = document.getElementById('agenticOption');
            const proceedButton = document.getElementById('proceedButton');
            const returningUserButton = document.getElementById('returningUserButton');
            const loginButton = document.getElementById('loginButton');
            
            if (privateOption) privateOption.addEventListener('click', () => selectPrivacyOption('private'));
            if (agenticOption) agenticOption.addEventListener('click', () => selectPrivacyOption('agentic'));
            if (proceedButton) proceedButton.addEventListener('click', handlePrivacyConsent);
            if (returningUserButton) returningUserButton.addEventListener('click', showReturningUserForm);
            if (loginButton) loginButton.addEventListener('click', handleReturningUser);
            
            console.log('‚úÖ Privacy consent listeners attached');
            document.getElementById('sendButton')?.addEventListener('click', sendMessage);
            document.getElementById('messageInput')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            document.getElementById('videoToggleBtn')?.addEventListener('click', toggleVideoSystem);
            document.getElementById('analyzeVideoBtn')?.addEventListener('click', analyzeVideoEmotion);
            document.getElementById('resetSession')?.addEventListener('click', () => {
                if (confirm('Start a new session? This will clear the current chat.')) {
                    location.reload();
                }
            });
        }

        function selectPrivacyOption(option) {
            console.log('üìã Privacy option selected:', option);
            document.getElementById('privateOption')?.classList.remove('selected');
            document.getElementById('agenticOption')?.classList.remove('selected');
            document.getElementById('retentionSelector')?.classList.remove('show');
            document.getElementById('userCredentials')?.classList.remove('show');
            if (option === 'private') {
                document.getElementById('privateOption')?.classList.add('selected');
                const proceedBtn = document.getElementById('proceedButton');
                if (proceedBtn) proceedBtn.disabled = false;
                appState.agenticMode = false;
            } else {
                document.getElementById('agenticOption')?.classList.add('selected');
                document.getElementById('retentionSelector')?.classList.add('show');
                document.getElementById('userCredentials')?.classList.add('show');
                const proceedBtn = document.getElementById('proceedButton');
                if (proceedBtn) proceedBtn.disabled = false;
                appState.agenticMode = true;
            }
            console.log('‚úÖ Proceed button enabled');
        }

        function showReturningUserForm() {
            document.getElementById('userCredentials')?.classList.remove('show');
            document.getElementById('returningUser')?.classList.add('show');
        }

        async function handlePrivacyConsent() {
            if (!appState.sessionId) {
                alert('Session not initialized. Please refresh.');
                return;
            }
            let userChoice = {};
            if (appState.agenticMode) {
                const preferredName = document.getElementById('preferredName')?.value.trim();
                const password = document.getElementById('userPassword')?.value.trim();
                const retentionDays = parseInt(document.getElementById('retentionDays')?.value || '30');
                if (!preferredName || !password) {
                    alert('Please fill in your name and create a password.');
                    return;
                }
                userChoice = {
                    choice: 'remember',
                    retention_days: retentionDays,
                    preferred_name: preferredName,
                    password: password
                };
            } else {
                userChoice = {choice: 'private'};
            }
            try {
                const consentResponse = await fetch('/api/privacy/consent/request', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({session_id: appState.sessionId})
                });
                if (!consentResponse.ok) throw new Error('Failed to request consent');
                const response = await fetch('/api/privacy/consent/respond', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        session_id: appState.sessionId,
                        user_choice: userChoice
                    })
                });
                const data = await response.json();
                if (data.success) {
                    appState.consentCompleted = true;
                    hidePrivacyConsent();
                    if (data.agentic_mode) {
                        appState.userId = data.consent_result?.user_id;
                        if (data.consent_result?.user_id && data.consent_result?.password) {
                            showCredentialsModal(data.consent_result.user_id, data.consent_result.password);
                        }
                    }
                    updateModeIndicator();
                    addWelcomeMessage(data.agentic_mode);
                    setTimeout(() => document.getElementById('messageInput')?.focus(), 500);
                } else {
                    throw new Error(data.error || 'Failed to process consent');
                }
            } catch (error) {
                console.error('Consent error:', error);
                alert('Failed to process your choice. Please try again.');
            }
        }

        async function handleReturningUser() {
            const userId = document.getElementById('returningUserId')?.value.trim();
            const password = document.getElementById('returningPassword')?.value.trim();
            if (!userId || !password) {
                alert('Please enter both User ID and password.');
                return;
            }
            if (!appState.sessionId) {
                alert('Session not initialized. Please refresh.');
                return;
            }
            try {
                const response = await fetch('/api/user/authenticate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        session_id: appState.sessionId,
                        user_id: userId,
                        password: password
                    })
                });
                const data = await response.json();
                if (data.success) {
                    appState.agenticMode = true;
                    appState.userId = userId;
                    appState.consentCompleted = true;
                    hidePrivacyConsent();
                    updateModeIndicator();
                    addWelcomeMessage(true, data.auth_result);
                    setTimeout(() => document.getElementById('messageInput')?.focus(), 500);
                } else {
                    alert('Authentication failed: ' + (data.auth_result?.message || 'Invalid credentials'));
                }
            } catch (error) {
                console.error('Auth error:', error);
                alert('Authentication failed. Please try again.');
            }
        }

        function hidePrivacyConsent() {
            console.log('üîí Hiding privacy consent overlay');
            const overlay = document.getElementById('privacyOverlay');
            if (overlay) {
                overlay.style.display = 'none';
                overlay.style.visibility = 'hidden';
                overlay.style.opacity = '0';
                console.log('‚úÖ Privacy consent hidden');
            } else {
                console.error('‚ùå Privacy overlay not found when hiding!');
            }
            enableChatInterface();
        }

        function disableChatInterface() {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            if (messageInput) messageInput.disabled = true;
            if (sendButton) sendButton.disabled = true;
        }

        function enableChatInterface() {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            if (messageInput) messageInput.disabled = false;
            if (sendButton) sendButton.disabled = false;
        }

        function updateModeIndicator() {
            const indicator = document.getElementById('modeIndicator');
            if (!indicator) return;
            if (appState.agenticMode) {
                indicator.textContent = 'ü§ñ Agentic Mode: Learning & Remembering';
                indicator.style.background = 'rgba(0, 0, 0, 0.2)';
            } else {
                indicator.textContent = 'üîì Private Mode: No Memory';
                indicator.style.background = 'rgba(255, 255, 255, 0.1)';
            }
        }

        async function createNewSession() {
            try {
                const response = await fetch('/api/session/new', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                const data = await response.json();
                if (data.success) {
                    appState.sessionId = data.session_id;
                    appState.sessionStartTime = new Date();
                    appState.consentCompleted = false;
                    const sessionIdElement = document.getElementById('sessionId');
                    if (sessionIdElement) {
                        sessionIdElement.textContent = data.session_id.substring(0, 8) + '...';
                    }
                } else {
                    throw new Error(data.error || 'Failed to create session');
                }
            } catch (error) {
                console.error('Session error:', error);
            }
        }

        async function checkProviderStatus() {
            try {
                const response = await fetch('/api/providers/status');
                const data = await response.json();
            } catch (error) {
                console.error('Provider check error:', error);
            }
        }

        async function initializeVideoSystem() {
            try {
                const response = await fetch('/api/video/status');
                const data = await response.json();
                if (data.success) {
                    appState.videoAvailable = data.status.emotion_detection_available;
                    const videoToggleBtn = document.getElementById('videoToggleBtn');
                    if (videoToggleBtn) videoToggleBtn.disabled = !appState.videoAvailable;
                }
            } catch (error) {
                console.error('Video init error:', error);
            }
        }

        async function toggleVideoSystem() {
            const videoToggleBtn = document.getElementById('videoToggleBtn');
            const analyzeVideoBtn = document.getElementById('analyzeVideoBtn');
            const videoStreamContainer = document.getElementById('videoStreamContainer');
            const videoInstructions = document.getElementById('videoInstructions');
            if (appState.videoEnabled) {
                try {
                    await fetch('/api/video/stop', {method: 'POST'});
                } catch (error) {
                    console.error('Stop video error:', error);
                }
                appState.videoEnabled = false;
                if (videoToggleBtn) videoToggleBtn.textContent = 'üìπ Enable Video';
                if (analyzeVideoBtn) analyzeVideoBtn.disabled = true;
                if (videoStreamContainer) videoStreamContainer.style.display = 'none';
                if (videoInstructions) videoInstructions.textContent = 'Enable video for facial expression analysis';
                stopVideoStream();
            } else {
                try {
                    const response = await fetch('/api/video/start', {method: 'POST'});
                    const data = await response.json();
                    if (data.success) {
                        appState.videoEnabled = true;
                        if (videoToggleBtn) videoToggleBtn.textContent = 'üö´ Disable Video';
                        if (analyzeVideoBtn) analyzeVideoBtn.disabled = false;
                        if (videoInstructions) videoInstructions.textContent = 'Video system active - Backend processing';
                        // Don't show video stream container since backend handles camera
                        // if (videoStreamContainer) videoStreamContainer.style.display = 'block';
                        // Don't start browser video stream - backend has the camera
                        // startVideoStream();
                    } else {
                        alert('Failed to start video: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Start video error:', error);
                    alert('Failed to start video system');
                }
            }
        }

        async function analyzeVideoEmotion() {
            if (!appState.videoEnabled) return;
            try {
                const response = await fetch('/api/video/analyze', {method: 'POST'});
                const data = await response.json();
                if (data.success) {
                    updateVideoEmotionDisplay(data);
                }
            } catch (error) {
                console.error('Video analysis error:', error);
            }
        }

        function updateVideoEmotionDisplay(analysisData) {
            const emotionDisplay = document.getElementById('videoEmotionDisplay');
            const emotionEmoji = document.getElementById('emotionEmoji');
            const emotionText = document.getElementById('emotionText');
            const emotionConfidence = document.getElementById('emotionConfidence');
            const emotion = analysisData.dominant_emotion || 'neutral';
            const confidence = Math.round((analysisData.confidence || 0) * 100);
            const emojiMap = {
                happy: 'üòä', sad: 'üò¢', angry: 'üò†', fear: 'üò∞',
                surprise: 'üò≤', disgust: 'ü§¢', neutral: 'üòê'
            };
            if (emotionEmoji) emotionEmoji.textContent = emojiMap[emotion] || 'üòê';
            if (emotionText) emotionText.textContent = emotion.charAt(0).toUpperCase() + emotion.slice(1);
            if (emotionConfidence) emotionConfidence.textContent = `${confidence}%`;
            if (emotionDisplay) emotionDisplay.style.display = 'block';
        }

        async function startVideoStream() {
            try {
                const videoElement = document.getElementById('videoStream');
                if (!videoElement) {
                    console.error('Video element not found');
                    return;
                }
                
                console.log('Requesting camera access...');
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                });
                
                console.log('Camera access granted, setting up stream...');
                videoElement.srcObject = stream;
                
                // Wait for video to be loaded
                videoElement.onloadedmetadata = () => {
                    console.log('Video metadata loaded');
                    videoElement.play().then(() => {
                        console.log('‚úÖ Video stream started and playing successfully');
                    }).catch(err => {
                        console.error('Play error:', err);
                    });
                };
                
            } catch (error) {
                console.error('Video stream error:', error);
                if (error.name === 'NotAllowedError') {
                    alert('Camera permission denied. Please allow camera access in your browser settings.');
                } else if (error.name === 'NotFoundError') {
                    alert('No camera found. Please connect a camera and try again.');
                } else {
                    alert('Could not start video: ' + error.message);
                }
            }
        }

        function stopVideoStream() {
            try {
                const videoElement = document.getElementById('videoStream');
                if (!videoElement) return;
                const stream = videoElement.srcObject;
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    videoElement.srcObject = null;
                }
            } catch (error) {
                console.error('Stop stream error:', error);
            }
        }

        async function sendMessage() {
            if (!appState.consentCompleted) return;
            if (!appState.sessionId) return;
            const messageInput = document.getElementById('messageInput');
            if (!messageInput) return;
            const message = messageInput.value.trim();
            if (!message) return;
            const sendButton = document.getElementById('sendButton');
            messageInput.disabled = true;
            if (sendButton) sendButton.disabled = true;
            messageInput.value = '';
            messageInput.style.height = 'auto';
            const userMsg = {
                role: 'user',
                content: message,
                timestamp: new Date().toISOString()
            };
            addMessage(userMsg);
            appState.chatHistory.push(userMsg);
            showLoading(true);
            try {
                const includeVideo = document.getElementById('includeVideo')?.checked || false;
                const response = await fetch('/api/chat/send', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        session_id: appState.sessionId,
                        message: message,
                        settings: appState.settings,
                        include_video: includeVideo && appState.videoEnabled
                    })
                });
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                const data = await response.json();
                if (data.success) {
                    const assistantMsg = data.assistant_response;
                    addMessage(assistantMsg);
                    appState.chatHistory.push(assistantMsg);
                    if (data.analysis) {
                        showAnalysis(data.analysis);
                    }
                    if (data.video_analysis && data.video_analysis.faces_detected > 0) {
                        showVideoAnalysisInChat(data.video_analysis);
                    }
                    if (data.crisis_detected) {
                        showCrisisAlert();
                    }
                } else {
                    throw new Error(data.error || 'Failed to process message');
                }
            } catch (error) {
                console.error('Message error:', error);
                const fallbackMsg = {
                    role: 'assistant',
                    content: 'I apologize, but I encountered a technical difficulty. ' + error.message,
                    timestamp: new Date().toISOString(),
                    provider: 'System'
                };
                addMessage(fallbackMsg);
            } finally {
                showLoading(false);
                messageInput.disabled = false;
                if (sendButton) sendButton.disabled = false;
                messageInput.focus();
            }
        }

        function addWelcomeMessage(agenticMode = false, authResult = null) {
            let welcomeContent = '';
            if (agenticMode && authResult?.proactive_checkin) {
                welcomeContent = authResult.checkin_message || 'Welcome back!';
            } else if (agenticMode) {
                welcomeContent = 'Welcome to Agentic Therapy AI! I can remember our conversations and provide personalized support.';
            } else {
                welcomeContent = 'Hello! I\'m here to provide mental health support. For emergencies, call 112 or KIRAN helpline 1800-599-0019.';
            }
            const welcomeMsg = {
                role: 'assistant',
                content: welcomeContent,
                timestamp: new Date().toISOString(),
                provider: 'System'
            };
            addMessage(welcomeMsg);
        }

        function addMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.role} fade-in`;
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            avatarDiv.textContent = message.role === 'user' ? 'You' : 'AI';
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            const messageText = document.createElement('div');
            messageText.innerHTML = message.content.replace(/\n/g, '<br>');
            contentDiv.appendChild(messageText);
            const metaDiv = document.createElement('div');
            metaDiv.className = 'message-meta';
            const time = new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            metaDiv.textContent = `‚è∞ ${time}`;
            if (message.provider) {
                metaDiv.textContent += ` ‚Ä¢ ${message.provider}`;
            }
            contentDiv.appendChild(metaDiv);
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }

        function showAnalysis(analysis) {
            const messages = document.querySelectorAll('.message.user');
            const lastMessage = messages[messages.length - 1];
            if (lastMessage && !lastMessage.querySelector('.analysis-panel')) {
                const analysisDiv = document.createElement('div');
                analysisDiv.className = 'analysis-panel fade-in';
                const emotion = analysis.dominant_emotion || 'neutral';
                const sentiment = analysis.sentiment || 'neutral';
                const crisisLevel = Math.round((analysis.crisis_level || 0) * 100);
                analysisDiv.innerHTML = `
                    <div class="analysis-metrics">
                        <div class="metric">
                            <div class="metric-value">${emotion}</div>
                            <div class="metric-label">Emotion</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${sentiment}</div>
                            <div class="metric-label">Sentiment</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${crisisLevel}%</div>
                            <div class="metric-label">Crisis Risk</div>
                        </div>
                    </div>
                `;
                lastMessage.appendChild(analysisDiv);
            }
        }

        function showVideoAnalysisInChat(videoAnalysis) {
            const messages = document.querySelectorAll('.message.assistant');
            const lastMessage = messages[messages.length - 1];
            if (lastMessage && !lastMessage.querySelector('.video-analysis-panel')) {
                const videoDiv = document.createElement('div');
                videoDiv.className = 'video-analysis-panel fade-in';
                videoDiv.style.marginTop = '10px';
                videoDiv.style.padding = '12px';
                videoDiv.style.background = '#f5f5f5';
                videoDiv.style.borderRadius = '8px';
                videoDiv.style.border = '2px solid #ccc';
                const emotion = videoAnalysis.dominant_emotion || 'neutral';
                const confidence = Math.round((videoAnalysis.confidence || 0) * 100);
                const icon = videoAnalysis.emotion_icon || 'üìπ';
                videoDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.5em;">${icon}</span>
                        <div>
                            <strong>Video Analysis</strong><br>
                            <span style="font-size: 0.9em; color: #666;">
                                Detected: <strong>${emotion}</strong> (${confidence}% confidence)
                            </span>
                        </div>
                    </div>
                `;
                lastMessage.appendChild(videoDiv);
            }
        }

        function showCrisisAlert() {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;
            const alertDiv = document.createElement('div');
            alertDiv.className = 'crisis-alert fade-in';
            alertDiv.innerHTML = `
                <strong>üö® Crisis Support Available</strong><br>
                Your safety is important. Please consider reaching out:<br><br>
                <strong>1800-599-0019</strong> - KIRAN Mental Health Helpline (24/7)<br>
                <strong>9152987821</strong> - Vandrevala Foundation Helpline (24/7)<br>
                <strong>112</strong> - Emergency services<br><br>
                Remember: You are not alone, and help is available.
            `;
            chatMessages.appendChild(alertDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showLoading(show) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                if (show) {
                    loadingIndicator.classList.add('show');
                } else {
                    loadingIndicator.classList.remove('show');
                }
            }
        }

        // ============================================
        // NEW FEATURES IMPLEMENTATION
        // ============================================

        // Update setupEventListeners to include all new buttons
        function setupAllEventListeners() {
            // Voice buttons
            document.getElementById('voiceInputBtn')?.addEventListener('click', startVoiceInput);
            document.getElementById('voiceOutputBtn')?.addEventListener('click', toggleVoiceOutput);
            document.getElementById('quickVoiceBtn')?.addEventListener('click', startVoiceInput);
            document.getElementById('autoSpeakToggle')?.addEventListener('change', function() {
                appState.autoSpeak = this.checked;
            });

            // Video continuous monitoring
            document.getElementById('continuousMonitorToggle')?.addEventListener('change', function() {
                if (this.checked && appState.videoEnabled) {
                    startContinuousMonitoring();
                } else {
                    stopContinuousMonitoring();
                }
            });

            // Goals
            document.getElementById('createGoalBtn')?.addEventListener('click', () => openModal('createGoalModal'));

            // Crisis resources
            document.getElementById('copingStrategiesBtn')?.addEventListener('click', showCopingStrategies);

            // Dashboard
            document.getElementById('viewFullDashboardBtn')?.addEventListener('click', () => openModal('fullDashboardModal'));

            // Settings
            document.getElementById('accountSettingsBtn')?.addEventListener('click', () => {
                openModal('accountSettingsModal');
                updateAccountSettingsDisplay();
            });
            document.getElementById('exportDataBtn')?.addEventListener('click', exportUserData);
            document.getElementById('deleteAccountBtn')?.addEventListener('click', deleteAccount);
        }

        // Call this in initializeApp
        async function enhancedInitializeApp() {
            try {
                console.log('üöÄ Initializing app...');
                
                // Ensure privacy overlay is visible
                const overlay = document.getElementById('privacyOverlay');
                if (overlay) {
                    overlay.style.display = 'flex';
                    overlay.style.visibility = 'visible';
                    overlay.style.opacity = '1';
                    console.log('‚úÖ Privacy overlay displayed');
                } else {
                    console.error('‚ùå Privacy overlay not found!');
                }
                
                disableChatInterface();
                setupEventListeners();
                setupAllEventListeners(); // Add new listeners
                await createNewSession();
                await checkProviderStatus();
                await initializeVideoSystem();
                await initializeVoiceSystem();
                startDurationCounter();
                startMessageCounter();
            } catch (error) {
                console.error('Init failed:', error);
            }
        }

        // Section toggle function
        function toggleSection(sectionName) {
            const section = document.getElementById(`${sectionName}-section`)?.closest('.section');
            if (section) {
                section.classList.toggle('collapsed');
            }
        }

        // Modal functions
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.add('show');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('show');
        }

        // ============================================
        // CREDENTIALS MODAL FUNCTIONS
        // ============================================

        let savedCredentials = { userId: '', password: '' };

        function showCredentialsModal(userId, password) {
            savedCredentials = { userId, password };
            document.getElementById('displayUserId').textContent = userId;
            document.getElementById('displayPassword').textContent = password;
            openModal('credentialsModal');
        }

        function closeCredentialsModal() {
            closeModal('credentialsModal');
            // Focus on message input
            setTimeout(() => document.getElementById('messageInput')?.focus(), 300);
        }

        async function copyToClipboard(type) {
            const text = type === 'userId' ? savedCredentials.userId : savedCredentials.password;
            const button = event.target.closest('.copy-btn');
            
            try {
                await navigator.clipboard.writeText(text);
                
                // Visual feedback
                const originalContent = button.innerHTML;
                button.innerHTML = 'Copied';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.classList.remove('copied');
                }, 2000);
                
            } catch (err) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    const originalContent = button.innerHTML;
                    button.innerHTML = 'Copied';
                    button.classList.add('copied');
                    
                    setTimeout(() => {
                        button.innerHTML = originalContent;
                        button.classList.remove('copied');
                    }, 2000);
                } catch (err2) {
                    alert('Failed to copy. Please manually copy the text.');
                }
                
                document.body.removeChild(textArea);
            }
        }

        function downloadCredentials() {
            const content = `Agentic Therapy AI - Account Credentials
========================================

User ID: ${savedCredentials.userId}
Password: ${savedCredentials.password}

IMPORTANT: Keep these credentials safe and secure.
You will need them to access your account.

Date Created: ${new Date().toLocaleString()}
`;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `therapy_ai_credentials_${savedCredentials.userId}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Show success message
            alert('Credentials downloaded successfully!');
        }

        // Duration counter
        function startDurationCounter() {
            setInterval(() => {
                if (appState.sessionStartTime) {
                    const duration = Math.floor((new Date() - appState.sessionStartTime) / 1000 / 60);
                    const hours = Math.floor(duration / 60);
                    const minutes = duration % 60;
                    const durationEl = document.getElementById('sessionDuration');
                    if (durationEl) {
                        durationEl.textContent = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
                    }
                }
            }, 30000);
        }

        // Message counter
        function startMessageCounter() {
            const originalAddMessage = window.addMessage;
            window.addMessage = function(...args) {
                originalAddMessage.apply(this, args);
                const messageCount = document.getElementById('messageCount');
                if (messageCount) {
                    const count = document.querySelectorAll('.message').length;
                    messageCount.textContent = count;
                }
            };
        }

        // ============================================
        // VOICE FEATURES
        // ============================================

        async function initializeVoiceSystem() {
            try {
                const response = await fetch('/api/voice/status');
                const data = await response.json();
                if (data.success && data.status) {
                    appState.voiceEnabled = data.status.speech_recognition_available && data.status.text_to_speech_available;
                    updateVoiceStatus(appState.voiceEnabled);
                }
            } catch (error) {
                console.error('Voice init error:', error);
                appState.voiceEnabled = false;
                updateVoiceStatus(false);
            }
        }

        function updateVoiceStatus(available) {
            const statusIndicator = document.getElementById('voiceStatus');
            const statusText = document.getElementById('voiceStatusText');
            if (statusIndicator && statusText) {
                if (available) {
                    statusIndicator.className = 'status-indicator status-active';
                    statusText.textContent = 'Voice ready';
                } else {
                    statusIndicator.className = 'status-indicator status-inactive';
                    statusText.textContent = 'Voice unavailable';
                }
            }
        }

        async function startVoiceInput() {
            if (!appState.voiceEnabled) {
                alert('Voice input is not available. Please check your microphone.');
                return;
            }

            const quickVoiceBtn = document.getElementById('quickVoiceBtn');
            if (appState.isListening) {
                stopVoiceInput();
                return;
            }

            try {
                appState.isListening = true;
                if (quickVoiceBtn) {
                    quickVoiceBtn.classList.add('active');
                    quickVoiceBtn.textContent = 'üî¥';
                }

                const response = await fetch('/api/voice/listen', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({})
                });

                const data = await response.json();
                if (data.success && data.text) {
                    const messageInput = document.getElementById('messageInput');
                    if (messageInput) {
                        messageInput.value = data.text;
                        messageInput.focus();
                    }
                } else {
                    alert(data.error || 'Could not understand speech');
                }
            } catch (error) {
                console.error('Voice input error:', error);
                alert('Voice input failed: ' + error.message);
            } finally {
                stopVoiceInput();
            }
        }

        function stopVoiceInput() {
            appState.isListening = false;
            const quickVoiceBtn = document.getElementById('quickVoiceBtn');
            if (quickVoiceBtn) {
                quickVoiceBtn.classList.remove('active');
                quickVoiceBtn.textContent = 'üéôÔ∏è';
            }
        }

        async function speakText(text) {
            if (!appState.voiceEnabled || !text) return;

            try {
                appState.isSpeaking = true;
                const response = await fetch('/api/voice/speak', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({text: text})
                });

                const data = await response.json();
                if (!data.success) {
                    console.error('TTS failed:', data.error);
                }
            } catch (error) {
                console.error('Voice output error:', error);
            } finally {
                appState.isSpeaking = false;
            }
        }

        async function toggleVoiceOutput() {
            const messages = document.querySelectorAll('.message.assistant');
            const lastMessage = messages[messages.length - 1];
            if (lastMessage) {
                const content = lastMessage.textContent;
                await speakText(content);
            }
        }

        // ============================================
        // CONTINUOUS VIDEO MONITORING
        // ============================================

        let monitoringInterval = null;

        async function startContinuousMonitoring() {
            if (!appState.videoEnabled) return;
            
            appState.continuousMonitoring = true;
            document.getElementById('videoInstructions').textContent = 'üî¥ Continuous monitoring active';

            monitoringInterval = setInterval(async () => {
                if (appState.videoEnabled && appState.continuousMonitoring) {
                    await analyzeVideoEmotion();
                }
            }, 5000); // Analyze every 5 seconds
        }

        function stopContinuousMonitoring() {
            appState.continuousMonitoring = false;
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
            document.getElementById('videoInstructions').textContent = 'Video system active';
        }

        // Enhanced video analysis to track history
        const originalAnalyzeVideo = window.analyzeVideoEmotion;
        window.analyzeVideoEmotion = async function() {
            await originalAnalyzeVideo();
            
            // Add to emotion history
            const emotionText = document.getElementById('emotionText')?.textContent;
            const emotionEmoji = document.getElementById('emotionEmoji')?.textContent;
            
            if (emotionText && emotionEmoji) {
                appState.emotionHistory.push({
                    emotion: emotionText.toLowerCase(),
                    emoji: emotionEmoji,
                    timestamp: new Date()
                });

                // Keep only last 10
                if (appState.emotionHistory.length > 10) {
                    appState.emotionHistory.shift();
                }

                updateEmotionTrends();
                updateEmotionSummary();
            }
        };

        function updateEmotionTrends() {
            const trendsContainer = document.getElementById('emotionTrendsContainer');
            const trendsList = document.getElementById('emotionTrends');
            
            if (!trendsContainer || !trendsList || appState.emotionHistory.length === 0) return;

            trendsContainer.style.display = 'block';

            // Count emotions
            const emotionCounts = {};
            appState.emotionHistory.forEach(item => {
                emotionCounts[item.emotion] = (emotionCounts[item.emotion] || 0) + 1;
            });

            // Sort by frequency
            const sorted = Object.entries(emotionCounts)
                .sort((a, b) => b[1] - b[1])
                .slice(0, 3);

            trendsList.innerHTML = sorted.map(([emotion, count]) => {
                const percentage = Math.round((count / appState.emotionHistory.length) * 100);
                const emoji = appState.emotionHistory.find(e => e.emotion === emotion)?.emoji || 'üòê';
                return `
                    <div class="emotion-trend">
                        <span class="emotion-icon">${emoji}</span>
                        <div class="emotion-data">
                            <div class="emotion-name">${emotion.charAt(0).toUpperCase() + emotion.slice(1)}</div>
                            <div class="emotion-percentage">${percentage}% of recent</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateEmotionSummary() {
            const summaryEl = document.getElementById('emotionSummary');
            if (!summaryEl || appState.emotionHistory.length === 0) return;

            const recent = appState.emotionHistory[appState.emotionHistory.length - 1];
            summaryEl.textContent = `${recent.emoji} ${recent.emotion.charAt(0).toUpperCase() + recent.emotion.slice(1)}`;
        }

        // ============================================
        // GOAL TRACKING
        // ============================================

        async function loadGoals() {
            if (!appState.agenticMode || !appState.userId) return;

            try {
                const response = await fetch(`/api/goals/list?session_id=${appState.sessionId}`);
                const data = await response.json();
                
                if (data.success && data.goals) {
                    appState.currentGoals = data.goals;
                    displayGoals(data.goals);
                }
            } catch (error) {
                console.error('Load goals error:', error);
            }
        }

        function displayGoals(goals) {
            const goalsList = document.getElementById('goalsList');
            const container = document.getElementById('goalsListContainer');
            
            if (!goalsList || !container) return;

            if (goals.length === 0) {
                goalsList.innerHTML = '';
                container.querySelector('small').style.display = 'block';
                return;
            }

            container.querySelector('small').style.display = 'none';
            goalsList.innerHTML = goals.map(goal => `
                <div class="goal-item">
                    <div class="goal-title">${goal.title}</div>
                    <div class="goal-description">${goal.description || 'No description'}</div>
                    <div class="goal-progress">
                        <div class="progress-bar" style="flex: 1;">
                            <div class="progress-fill" style="width: ${goal.progress_score || 0}%"></div>
                        </div>
                        <span>${goal.progress_score || 0}%</span>
                    </div>
                    <small style="color: #666;">
                        Created: ${new Date(goal.created_at).toLocaleDateString()}
                    </small>
                </div>
            `).join('');
        }

        async function createGoal() {
            const title = document.getElementById('goalTitle')?.value.trim();
            const description = document.getElementById('goalDescription')?.value.trim();
            const category = document.getElementById('goalCategory')?.value;
            const targetDate = document.getElementById('goalTarget')?.value;

            if (!title) {
                alert('Please enter a goal title');
                return;
            }

            if (!appState.agenticMode || !appState.sessionId) {
                alert('Goals are only available in Agentic Mode');
                return;
            }

            try {
                const response = await fetch('/api/goals/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        session_id: appState.sessionId,
                        goal: {
                            title: title,
                            description: description,
                            category: category,
                            target_date: targetDate || null
                        }
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('Goal created successfully!');
                    closeModal('createGoalModal');
                    // Clear form
                    document.getElementById('goalTitle').value = '';
                    document.getElementById('goalDescription').value = '';
                    document.getElementById('goalTarget').value = '';
                    // Reload goals
                    await loadGoals();
                } else {
                    alert('Failed to create goal: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Create goal error:', error);
                alert('Failed to create goal');
            }
        }

        // ============================================
        // COPING STRATEGIES
        // ============================================

        async function showCopingStrategies() {
            openModal('copingStrategiesModal');
            
            if (appState.copingStrategiesCache) {
                displayCopingStrategies(appState.copingStrategiesCache);
                return;
            }

            try {
                // Use general_distress as default
                const response = await fetch('/api/crisis/coping-strategies?crisis_type=general_distress');
                const data = await response.json();
                
                if (data.success && data.strategies) {
                    appState.copingStrategiesCache = data.strategies;
                    displayCopingStrategies(data.strategies);
                }
            } catch (error) {
                console.error('Load coping strategies error:', error);
            }
        }

        function displayCopingStrategies(strategies) {
            const immediate = document.getElementById('immediateStrategiesList');
            const shortTerm = document.getElementById('shortTermStrategiesList');
            const longTerm = document.getElementById('longTermStrategiesList');

            if (strategies.immediate && immediate) {
                immediate.innerHTML = strategies.immediate.map(s => 
                    `<div class="coping-strategy">‚Ä¢ ${s}</div>`
                ).join('');
            }

            if (strategies.short_term && shortTerm) {
                shortTerm.innerHTML = strategies.short_term.map(s => 
                    `<div class="coping-strategy">‚Ä¢ ${s}</div>`
                ).join('');
            }

            if (strategies.long_term && longTerm) {
                longTerm.innerHTML = strategies.long_term.map(s => 
                    `<div class="coping-strategy">‚Ä¢ ${s}</div>`
                ).join('');
            }
        }

        function showCopingTab(tabName) {
            // Deactivate all tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            // Activate selected tab
            event.target.classList.add('active');
            document.getElementById(`${tabName}-coping`)?.classList.add('active');
        }

        // ============================================
        // ACCOUNT MANAGEMENT
        // ============================================

        function updateAccountSettingsDisplay() {
            document.getElementById('displayUserId').textContent = appState.userId || 'Not logged in';
            document.getElementById('displayAgenticMode').textContent = appState.agenticMode ? 'Enabled' : 'Private Session';
            document.getElementById('displayRetention').textContent = appState.agenticMode ? 'Encrypted locally' : 'Session only';

            // Enable/disable buttons
            const exportBtn = document.getElementById('exportDataBtn');
            const deleteBtn = document.getElementById('deleteAccountBtn');
            
            if (exportBtn) exportBtn.disabled = !appState.agenticMode;
            if (deleteBtn) deleteBtn.disabled = !appState.agenticMode;
        }

        async function exportUserData() {
            if (!appState.agenticMode || !appState.userId) return;

            try {
                const response = await fetch(`/api/dashboard?session_id=${appState.sessionId}`);
                const data = await response.json();

                if (data.success) {
                    const dataStr = JSON.stringify(data, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `therapy-data-${appState.userId}-${new Date().toISOString().split('T')[0]}.json`;
                    link.click();
                    URL.revokeObjectURL(url);
                } else {
                    alert('Failed to export data');
                }
            } catch (error) {
                console.error('Export error:', error);
                alert('Failed to export data');
            }
        }

        async function deleteAccount() {
            if (!appState.agenticMode || !appState.userId) return;

            const confirm = window.confirm(
                'Are you sure you want to delete your account and all data?\n\n' +
                'This action cannot be undone. All your:\n' +
                '‚Ä¢ Conversation history\n' +
                '‚Ä¢ Goals and progress\n' +
                '‚Ä¢ Personal preferences\n' +
                'will be permanently deleted.'
            );

            if (!confirm) return;

            const finalConfirm = window.prompt('Type "DELETE" to confirm:');
            if (finalConfirm !== 'DELETE') {
                alert('Deletion cancelled');
                return;
            }

            try {
                const password = window.prompt('Enter your password to confirm:');
                if (!password) return;

                const response = await fetch('/api/user/delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        session_id: appState.sessionId,
                        user_id: appState.userId,
                        password: password
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('Account deleted successfully. You will be redirected to a new session.');
                    location.reload();
                } else {
                    alert('Failed to delete account: ' + (data.error || 'Invalid password'));
                }
            } catch (error) {
                console.error('Delete account error:', error);
                alert('Failed to delete account');
            }
        }

        // ============================================
        // ENHANCED MESSAGE HANDLING
        // ============================================

        // Wrap the original sendMessage to add multimodal support
        const originalSendMessage = window.sendMessage;
        window.sendMessage = async function() {
            const useMultimodal = document.getElementById('useMultimodal')?.checked;
            const includeVoice = document.getElementById('includeVoice')?.checked;
            
            if (useMultimodal) {
                await sendMultimodalMessage();
            } else {
                await originalSendMessage();
                
                // Auto-speak if enabled
                if (appState.autoSpeak && appState.voiceEnabled) {
                    setTimeout(async () => {
                        const messages = document.querySelectorAll('.message.assistant');
                        const lastMessage = messages[messages.length - 1];
                        if (lastMessage) {
                            const content = lastMessage.querySelector('.message-content')?.textContent || '';
                            // Remove metadata
                            const cleanContent = content.split('‚è∞')[0].trim();
                            await speakText(cleanContent);
                        }
                    }, 1000);
                }
            }
        };

        async function sendMultimodalMessage() {
            if (!appState.consentCompleted || !appState.sessionId) return;

            const messageInput = document.getElementById('messageInput');
            if (!messageInput) return;

            const message = messageInput.value.trim();
            if (!message) return;

            const sendButton = document.getElementById('sendButton');
            messageInput.disabled = true;
            if (sendButton) sendButton.disabled = true;
            messageInput.value = '';
            messageInput.style.height = 'auto';

            const userMsg = {
                role: 'user',
                content: message,
                timestamp: new Date().toISOString()
            };
            addMessage(userMsg);
            appState.chatHistory.push(userMsg);
            showLoading(true);

            try {
                const includeVideo = document.getElementById('includeVideo')?.checked && appState.videoEnabled;
                const includeVoice = document.getElementById('includeVoice')?.checked && appState.voiceEnabled;

                const response = await fetch('/api/chat/multimodal', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        session_id: appState.sessionId,
                        message: message,
                        include_video: includeVideo,
                        include_voice: includeVoice,
                        settings: appState.settings
                    })
                });

                if (!response.ok) throw new Error(`Server error: ${response.status}`);

                const data = await response.json();
                if (data.success) {
                    const assistantMsg = data.assistant_response;
                    addMessage(assistantMsg);
                    appState.chatHistory.push(assistantMsg);

                    if (data.analysis) showAnalysis(data.analysis);
                    if (data.video_analysis) showVideoAnalysisInChat(data.video_analysis);
                    if (data.crisis_detected) showCrisisAlert();

                    // Auto-speak if enabled
                    if (appState.autoSpeak && appState.voiceEnabled) {
                        await speakText(assistantMsg.content);
                    }
                } else {
                    throw new Error(data.error || 'Failed to process message');
                }
            } catch (error) {
                console.error('Multimodal message error:', error);
                const fallbackMsg = {
                    role: 'assistant',
                    content: 'I apologize, but I encountered a technical difficulty. ' + error.message,
                    timestamp: new Date().toISOString(),
                    provider: 'System'
                };
                addMessage(fallbackMsg);
            } finally {
                showLoading(false);
                messageInput.disabled = false;
                if (sendButton) sendButton.disabled = false;
                messageInput.focus();
            }
        }

        // Update initialization to use enhanced version
        document.removeEventListener('DOMContentLoaded', initializeApp);
        document.addEventListener('DOMContentLoaded', enhancedInitializeApp);
    </script>
</body>
</html>
