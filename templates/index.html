<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentic Therapy AI - Advanced Mental Health Support</title>
    <style>
        /* Agentic Therapy AI - Enhanced Black & White Theme */

        :root {
            /* Black & White Color System */
            --primary-black: #000000;
            --primary-dark: #1a1a1a;
            --primary-gray-dark: #2d2d2d;
            --primary-gray: #404040;
            --primary-gray-medium: #666666;
            --primary-gray-light: #999999;
            --primary-light: #cccccc;
            --primary-lighter: #e6e6e6;
            --primary-lightest: #f5f5f5;
            --primary-white: #ffffff;
            
            /* Functional Colors */
            --text-primary: #000000;
            --text-secondary: #404040;
            --text-muted: #666666;
            --text-inverse: #ffffff;
            
            /* Background Colors */
            --bg-primary: #000000;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2d2d2d;
            --bg-light: #f5f5f5;
            --bg-lighter: #ffffff;
            
            /* Border Colors */
            --border-dark: #404040;
            --border-medium: #999999;
            --border-light: #cccccc;
            --border-lighter: #e6e6e6;
            
            /* Alert Colors (Grayscale) */
            --alert-dark: #1a1a1a;
            --alert-medium: #404040;
            --alert-light: #999999;
            
            /* Gradients */
            --gradient-dark: linear-gradient(135deg, #000000 0%, #2d2d2d 100%);
            --gradient-medium: linear-gradient(135deg, #1a1a1a 0%, #404040 100%);
            --gradient-light: linear-gradient(135deg, #f5f5f5 0%, #ffffff 100%);
            --gradient-reverse: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);
            
            /* Shadows */
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 20px 40px rgba(0, 0, 0, 0.2);
            --shadow-dark: 0 8px 16px rgba(0, 0, 0, 0.3);
            
            /* Spacing */
            --spacing-xs: 5px;
            --spacing-sm: 10px;
            --spacing-md: 15px;
            --spacing-lg: 20px;
            --spacing-xl: 25px;
            --spacing-xxl: 40px;
            
            /* Border Radius */
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 18px;
            --radius-xxl: 20px;
            --radius-round: 25px;
            --radius-circle: 50%;
            
            /* Typography */
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            --font-size-xs: 0.7em;
            --font-size-sm: 0.8em;
            --font-size-md: 0.9em;
            --font-size-base: 1em;
            --font-size-lg: 1.2em;
            --font-size-xl: 1.3em;
            --font-size-xxl: 1.4em;
            --font-size-title: 1.6em;
            
            /* Transitions */
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: var(--font-family);
            background: var(--gradient-dark);
            height: 100vh;
            width: 100vw;
            color: var(--text-primary);
            line-height: 1.6;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            width: 100vw;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 350px;
            min-width: 320px;
            background: var(--gradient-light);
            border-right: 2px solid var(--border-light);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: var(--spacing-lg);
            background: var(--gradient-dark);
            color: var(--text-inverse);
            text-align: center;
            flex-shrink: 0;
        }

        .sidebar-header h1 {
            font-size: var(--font-size-xl);
            margin-bottom: var(--spacing-xs);
            font-weight: 600;
        }

        .sidebar-header p {
            font-size: var(--font-size-md);
            opacity: 0.9;
        }

        .agentic-indicator {
            margin-top: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
        }

        .sidebar-content {
            padding: var(--spacing-lg);
            flex: 1;
            overflow-y: auto;
        }

        .section {
            margin-bottom: var(--spacing-xl);
            background: var(--bg-lighter);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-light);
            border: 2px solid var(--border-lighter);
        }

        .section h3 {
            margin-bottom: var(--spacing-md);
            color: var(--text-secondary);
            font-size: var(--font-size-md);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .select-field, .input-field-sidebar {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-lg);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            background: var(--bg-lighter);
            font-size: var(--font-size-md);
            margin-bottom: var(--spacing-sm);
            transition: all var(--transition-normal);
            color: var(--text-primary);
        }

        .select-field:focus, .input-field-sidebar:focus {
            outline: none;
            border-color: var(--primary-black);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .button-sidebar {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-lg);
            background: var(--gradient-dark);
            color: var(--text-inverse);
            border: 2px solid var(--primary-black);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            font-size: var(--font-size-md);
            transition: all var(--transition-normal);
            margin-bottom: var(--spacing-sm);
        }

        .button-sidebar:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
            background: var(--gradient-medium);
        }

        .button-sidebar:disabled {
            background: var(--primary-light);
            color: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            border-color: var(--border-light);
        }

        /* ===== MAIN AREA ===== */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-lighter);
            min-width: 0;
        }

        .chat-header {
            padding: var(--spacing-lg);
            background: var(--gradient-medium);
            color: var(--text-inverse);
            text-align: center;
            flex-shrink: 0;
        }

        .chat-header h2 {
            font-size: var(--font-size-xxl);
            margin-bottom: var(--spacing-xs);
            font-weight: 600;
        }

        .chat-header p {
            font-size: var(--font-size-base);
            opacity: 0.9;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        /* ===== CHAT MESSAGES ===== */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-lg);
            background: var(--gradient-reverse);
            scroll-behavior: smooth;
            min-height: 0;
        }

        .message {
            margin-bottom: var(--spacing-lg);
            display: flex;
            gap: var(--spacing-lg);
            align-items: flex-start;
            max-width: 100%;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-content {
            max-width: 75%;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-xl);
            position: relative;
            word-wrap: break-word;
            box-shadow: var(--shadow-light);
            flex: 1;
            min-width: 0;
        }

        .message.user .message-content {
            background: var(--gradient-dark);
            color: var(--text-inverse);
            border-bottom-right-radius: var(--radius-sm);
            border: 2px solid var(--primary-black);
        }

        .message.assistant .message-content {
            background: var(--bg-lighter);
            border: 2px solid var(--border-light);
            border-bottom-left-radius: var(--radius-sm);
            color: var(--text-primary);
        }

        .message.assistant.agentic .message-content {
            border-color: var(--primary-black);
            background: var(--primary-lightest);
        }

        .message-avatar {
            width: 38px;
            height: 38px;
            border-radius: var(--radius-circle);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--text-inverse);
            font-size: var(--font-size-sm);
            flex-shrink: 0;
            border: 2px solid var(--primary-black);
        }

        .message.user .message-avatar {
            background: var(--gradient-dark);
        }

        .message.assistant .message-avatar {
            background: var(--gradient-medium);
        }

        .message.assistant.agentic .message-avatar {
            background: var(--gradient-dark);
        }

        .message-meta {
            font-size: var(--font-size-xs);
            margin-top: var(--spacing-sm);
            opacity: 0.7;
        }

        .message.user .message-meta {
            color: rgba(255, 255, 255, 0.8);
        }

        .message.assistant .message-meta {
            color: var(--text-muted);
        }

        .agentic-features {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background: rgba(0, 0, 0, 0.05);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
        }

        .goal-progress {
            margin-bottom: var(--spacing-sm);
            font-size: var(--font-size-sm);
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--border-light);
            border-radius: 3px;
            overflow: hidden;
            margin: var(--spacing-xs) 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-dark);
            transition: width var(--transition-normal);
        }

        .proactive-suggestion {
            background: var(--primary-lightest);
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
            font-style: italic;
            font-size: var(--font-size-sm);
            border-left: 3px solid var(--primary-black);
        }

        /* ===== ANALYSIS PANEL ===== */
        .analysis-panel {
            background: var(--primary-lightest);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            margin-top: var(--spacing-lg);
            font-size: var(--font-size-sm);
        }

        .analysis-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .metric {
            background: var(--bg-lighter);
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            text-align: center;
            box-shadow: var(--shadow-light);
            border: 2px solid var(--border-lighter);
        }

        .metric-value {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--primary-black);
            margin-bottom: 4px;
        }

        .metric-label {
            font-size: var(--font-size-sm);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ===== CRISIS ALERT ===== */
        .crisis-alert {
            background: var(--gradient-dark);
            color: var(--text-inverse);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            margin: var(--spacing-md) 0;
            font-weight: 500;
            animation: pulse 2s infinite;
            box-shadow: var(--shadow-dark);
            border: 2px solid var(--primary-black);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.85; }
            100% { opacity: 1; }
        }

        /* ===== INPUT AREA ===== */
        .input-area {
            padding: var(--spacing-lg);
            background: var(--bg-lighter);
            border-top: 2px solid var(--border-light);
            flex-shrink: 0;
        }

        .input-container {
            display: flex;
            gap: var(--spacing-lg);
            align-items: flex-end;
            max-width: 100%;
        }

        .input-field {
            flex: 1;
            padding: var(--spacing-md) var(--spacing-lg);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-round);
            font-size: var(--font-size-base);
            resize: none;
            max-height: 120px;
            min-height: 50px;
            transition: all var(--transition-normal);
            font-family: inherit;
            line-height: 1.4;
            min-width: 0;
            background: var(--bg-lighter);
            color: var(--text-primary);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-black);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .input-field::placeholder {
            color: var(--text-muted);
        }

        .send-button {
            padding: var(--spacing-md) var(--spacing-xl);
            background: var(--gradient-dark);
            color: var(--text-inverse);
            border: 2px solid var(--primary-black);
            border-radius: var(--radius-round);
            cursor: pointer;
            font-weight: 600;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: var(--font-size-base);
            flex-shrink: 0;
            white-space: nowrap;
        }

        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-dark);
            background: var(--gradient-medium);
        }

        .send-button:disabled {
            background: var(--primary-light);
            color: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            border-color: var(--border-light);
        }

        /* ===== PRIVACY CONSENT OVERLAY ===== */
        .privacy-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            padding: var(--spacing-lg);
        }

        .privacy-modal {
            background: var(--bg-lighter);
            padding: var(--spacing-xxl);
            border-radius: var(--radius-xxl);
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            text-align: center;
            box-shadow: var(--shadow-heavy);
            border: 3px solid var(--primary-black);
        }

        .privacy-modal h2 {
            color: var(--primary-black);
            margin-bottom: var(--spacing-lg);
            font-size: var(--font-size-title);
            font-weight: 600;
        }

        .consent-content {
            text-align: left;
            margin: var(--spacing-lg) 0;
            padding: var(--spacing-lg);
            background: var(--primary-lightest);
            border-radius: var(--radius-lg);
            font-size: var(--font-size-md);
            line-height: 1.6;
            border: 2px solid var(--border-light);
        }

        .consent-content h4 {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
        }

        .consent-content ul {
            padding-left: var(--spacing-lg);
        }

        .consent-content li {
            margin-bottom: var(--spacing-sm);
        }

        .privacy-options {
            display: flex;
            gap: var(--spacing-lg);
            margin: var(--spacing-lg) 0;
        }

        .privacy-option {
            flex: 1;
            padding: var(--spacing-lg);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-normal);
            text-align: left;
        }

        .privacy-option:hover {
            border-color: var(--primary-black);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .privacy-option.selected {
            border-color: var(--primary-black);
            background: var(--primary-lightest);
        }

        .privacy-option h4 {
            margin-bottom: var(--spacing-sm);
            color: var(--primary-black);
        }

        .privacy-option p {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        .retention-selector {
            margin-top: var(--spacing-md);
            display: none;
        }

        .retention-selector.show {
            display: block;
        }

        .user-credentials {
            margin: var(--spacing-lg) 0;
            display: none;
        }

        .user-credentials.show {
            display: block;
        }

        .credential-field {
            padding: var(--spacing-md);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-lg);
            width: 100%;
            margin: var(--spacing-sm) 0;
            font-size: var(--font-size-base);
            transition: all var(--transition-normal);
            background: var(--bg-lighter);
            color: var(--text-primary);
        }

        .credential-field:focus {
            outline: none;
            border-color: var(--primary-black);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .consent-button {
            background: var(--gradient-dark);
            color: var(--text-inverse);
            border: 2px solid var(--primary-black);
            padding: var(--spacing-md) var(--spacing-xl);
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-size: var(--font-size-base);
            font-weight: 600;
            transition: all var(--transition-normal);
            width: 100%;
            max-width: 300px;
            margin: var(--spacing-sm);
        }

        .consent-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-dark);
            background: var(--gradient-medium);
        }

        .consent-button:disabled {
            background: var(--primary-light);
            color: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* ===== GOALS PANEL ===== */
        .goals-panel {
            background: var(--bg-lighter);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .goal-item {
            background: var(--primary-lightest);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
            border: 1px solid var(--border-light);
        }

        .goal-item h5 {
            color: var(--primary-black);
            margin-bottom: var(--spacing-xs);
            font-size: var(--font-size-md);
        }

        .goal-item p {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-sm);
        }

        /* ===== DASHBOARD PANEL ===== */
        .dashboard-panel {
            background: var(--bg-lighter);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .insight-item {
            background: var(--primary-lightest);
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
            font-size: var(--font-size-sm);
            border-left: 3px solid var(--primary-black);
        }

        /* ===== LOADING INDICATOR ===== */
        .loading {
            display: none;
            text-align: center;
            padding: var(--spacing-lg);
            color: var(--text-muted);
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-light);
            border-top: 4px solid var(--primary-black);
            border-radius: var(--radius-circle);
            animation: spin 1s linear infinite;
            margin: 0 auto var(--spacing-md);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== SESSION STATS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .stat-item {
            background: var(--bg-lighter);
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            text-align: center;
            border: 2px solid var(--border-lighter);
            box-shadow: var(--shadow-light);
        }

        .stat-value {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--primary-black);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ===== PROVIDER STATUS ===== */
        .provider-status {
            background: var(--bg-lighter);
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
            font-size: var(--font-size-sm);
            border: 2px solid var(--border-lighter);
        }

        .provider-status .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: var(--radius-circle);
            margin-right: var(--spacing-sm);
            border: 1px solid var(--primary-black);
        }

        .provider-status .status-dot.online {
            background: var(--primary-black);
        }

        .provider-status .status-dot.offline {
            background: var(--border-light);
        }

        .provider-status .status-dot.unknown {
            background: var(--primary-light);
        }

        /* ===== VOICE AND VIDEO CONTROLS ===== */
        .voice-status, .video-status {
            background: var(--bg-lighter);
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
            font-size: var(--font-size-sm);
            border: 2px solid var(--border-lighter);
        }

        .voice-status .status-dot, .video-status .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: var(--radius-circle);
            margin-right: var(--spacing-sm);
            border: 1px solid var(--primary-black);
        }

        .voice-status .status-dot.online, .video-status .status-dot.online {
            background: var(--primary-black);
        }

        .voice-status .status-dot.offline, .video-status .status-dot.offline {
            background: var(--border-light);
        }

        .voice-status .status-dot.unknown, .video-status .status-dot.unknown {
            background: var(--primary-light);
        }

        .video-stream-container {
            margin: var(--spacing-sm) 0;
            text-align: center;
            background: var(--bg-lighter);
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
            border: 2px solid var(--border-light);
        }

        .video-emotion-display {
            background: var(--primary-lightest);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin: var(--spacing-sm) 0;
            text-align: center;
            border: 2px solid var(--border-light);
        }

        .emotion-indicator {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--spacing-sm);
        }

        .emotion-emoji {
            font-size: var(--font-size-lg);
        }

        .emotion-text {
            font-weight: 600;
            color: var(--primary-black);
            flex: 1;
        }

        .emotion-confidence {
            font-size: var(--font-size-sm);
            color: var(--text-muted);
            background: var(--bg-lighter);
            padding: 2px 6px;
            border-radius: var(--radius-sm);
        }

        /* Voice and video buttons */
        .button-sidebar.voice-active {
            background: var(--gradient-dark);
            color: var(--text-inverse);
        }

        .button-sidebar.video-active {
            background: var(--gradient-dark);
            color: var(--text-inverse);
        }

        .button-sidebar.listening {
            background: var(--gradient-medium);
            animation: pulse 1.5s ease-in-out infinite;
        }

        .button-sidebar.analyzing {
            background: var(--gradient-medium);
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Multimodal input area */
        .multimodal-controls {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            align-items: center;
        }

        .multimodal-toggle {
            padding: var(--spacing-sm);
            background: var(--bg-lighter);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-normal);
            font-size: var(--font-size-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .multimodal-toggle:hover {
            border-color: var(--primary-black);
        }

        .multimodal-toggle.active {
            background: var(--primary-lightest);
            border-color: var(--primary-black);
            color: var(--primary-black);
            font-weight: 600;
        }

        .multimodal-toggle input[type="checkbox"] {
            display: none;
        }

        /* Voice input button */
        .voice-input-btn {
            width: 50px;
            height: 50px;
            border-radius: var(--radius-circle);
            background: var(--gradient-dark);
            color: var(--text-inverse);
            border: 2px solid var(--primary-black);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-lg);
            transition: all var(--transition-normal);
            flex-shrink: 0;
        }

        .voice-input-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .voice-input-btn:disabled {
            background: var(--primary-light);
            color: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .voice-input-btn.listening {
            background: var(--gradient-medium);
            animation: pulse 1s ease-in-out infinite;
        }

        /* ===== EMERGENCY RESOURCES ===== */
        .emergency-resources {
            background: var(--gradient-dark);
            color: var(--text-inverse);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            margin-top: var(--spacing-lg);
            box-shadow: var(--shadow-dark);
            border: 2px solid var(--primary-black);
        }

        .emergency-resources h4 {
            margin-bottom: var(--spacing-lg);
            font-size: var(--font-size-base);
        }

        .emergency-resources ul {
            list-style: none;
            font-size: var(--font-size-md);
        }

        .emergency-resources li {
            margin-bottom: var(--spacing-sm);
            padding: 2px 0;
        }

        /* ===== UTILITY CLASSES ===== */
        .hidden {
            display: none;
        }

        .fade-in {
            animation: fadeIn var(--transition-slow) ease-in;
        }

        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1200px) {
            .sidebar {
                width: 320px;
                min-width: 300px;
            }
        }

        @media (max-width: 1024px) {
            .sidebar {
                width: 280px;
                min-width: 260px;
            }
            
            .message-content {
                max-width: 80%;
            }
            
            .privacy-options {
                flex-direction: column;
            }
        }

        @media (max-width: 768px) {
            html {
                overflow: auto;
            }
            
            body {
                height: auto;
                min-height: 100vh;
                overflow: auto;
            }
            
            .container {
                flex-direction: column;
                height: 100vh;
                width: 100vw;
            }

            .sidebar {
                width: 100%;
                min-width: auto;
                max-height: 300px;
                order: 2;
                border-right: none;
                border-top: 2px solid var(--border-light);
            }
            
            .sidebar-content {
                padding: var(--spacing-md);
            }
            
            .section {
                padding: var(--spacing-sm);
                margin-bottom: var(--spacing-md);
            }

            .main-area {
                order: 1;
                flex: 1;
                min-height: 0;
            }
            
            .chat-messages {
                padding: var(--spacing-md);
            }
            
            .message-content {
                max-width: 85%;
            }
            
            .analysis-metrics {
                grid-template-columns: 1fr 1fr;
            }

            .privacy-modal {
                margin: var(--spacing-lg);
                padding: var(--spacing-lg);
                max-height: 85vh;
            }
            
            .input-area {
                padding: var(--spacing-md);
            }
            
            .input-container {
                gap: var(--spacing-sm);
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                max-height: 250px;
            }
            
            .sidebar-header {
                padding: var(--spacing-md);
            }
            
            .sidebar-header h1 {
                font-size: var(--font-size-lg);
            }
            
            .chat-header {
                padding: var(--spacing-md);
            }
            
            .chat-header h2 {
                font-size: var(--font-size-xl);
            }
            
            .input-container {
                flex-direction: column;
                gap: var(--spacing-sm);
            }

            .send-button {
                width: 100%;
                justify-content: center;
                padding: var(--spacing-md);
            }

            .message-content {
                max-width: 95%;
            }

            .analysis-metrics {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .privacy-modal {
                margin: var(--spacing-sm);
                padding: var(--spacing-lg);
            }
        }

        /* ===== SCROLLBAR STYLING ===== */
        .chat-messages::-webkit-scrollbar,
        .sidebar::-webkit-scrollbar,
        .privacy-modal::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track,
        .sidebar::-webkit-scrollbar-track,
        .privacy-modal::-webkit-scrollbar-track {
            background: var(--border-lighter);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb,
        .sidebar::-webkit-scrollbar-thumb,
        .privacy-modal::-webkit-scrollbar-thumb {
            background: var(--primary-black);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover,
        .sidebar::-webkit-scrollbar-thumb:hover,
        .privacy-modal::-webkit-scrollbar-thumb:hover {
            background: var(--primary-gray);
        }

        /* ===== FOCUS STATES FOR ACCESSIBILITY ===== */
        button:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible {
            outline: 2px solid var(--primary-black);
            outline-offset: 2px;
        }

        /* ===== SMOOTH TRANSITIONS ===== */
        * {
            transition: box-shadow var(--transition-normal), transform var(--transition-normal);
        }

        .section:hover,
        .stat-item:hover,
        .metric:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-1px);
        }

        /* ===== REDUCED MOTION ===== */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
            
            .fade-in {
                animation: none;
            }
            
            .crisis-alert {
                animation: none;
            }
        }
    </style>
</head>
<body>
    <!-- Privacy Consent Overlay -->
    <div id="privacyOverlay" class="privacy-overlay">
        <div class="privacy-modal">
            <h2>Agentic Therapy AI</h2>
            <p><strong>Advanced AI Assistant for Mental Health Support</strong></p>
            
            <div class="consent-content">
                <h4>Enhanced Features Available:</h4>
                <p>I can now offer two levels of support:</p>
                <ul>
                    <li><strong>Private Sessions:</strong> Standard support, no memory between sessions</li>
                    <li><strong>Agentic Mode:</strong> Remembers conversations, tracks goals, provides personalized insights</li>
                </ul>
                
                <h4>Privacy & Data Policy:</h4>
                <ul>
                    <li><strong>Your Choice:</strong> You control how your data is handled</li>
                    <li><strong>Local Only:</strong> All data stays on your device, never uploaded</li>
                    <li><strong>Encrypted:</strong> Your conversations are encrypted with your password</li>
                    <li><strong>Deletable:</strong> Delete your data anytime with one click</li>
                    <li><strong>Time-Limited:</strong> Choose how long to keep your data</li>
                </ul>
                
                <h4>Important Notes:</h4>
                <ul>
                    <li>This is an AI assistant, not a replacement for professional therapy</li>
                    <li>Crisis detection and emergency resources provided for safety</li>
                    <li>Emergency: Call 911 for immediate danger, 988 for crisis support</li>
                </ul>
            </div>
            
            <div class="privacy-options">
                <div class="privacy-option" id="privateOption">
                    <h4>Private Sessions</h4>
                    <p>Each session is independent. No data stored between conversations. Maximum privacy.</p>
                </div>
                <div class="privacy-option" id="agenticOption">
                    <h4>Agentic Mode</h4>
                    <p>Remember conversations, track therapeutic goals, provide personalized insights and proactive support.</p>
                    
                    <div class="retention-selector" id="retentionSelector">
                        <label for="retentionDays">Keep data for:</label>
                        <select id="retentionDays" class="select-field">
                            <option value="7">1 Week</option>
                            <option value="30" selected>1 Month</option>
                            <option value="90">3 Months</option>
                            <option value="365">1 Year</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="user-credentials" id="userCredentials">
                <h4>Setup Your Secure Account</h4>
                <input type="text" id="preferredName" class="credential-field" placeholder="What should I call you? (e.g., Alex)">
                <input type="password" id="userPassword" class="credential-field" placeholder="Create a secure password">
                <small>Your password encrypts all data locally. Keep it safe - it cannot be recovered.</small>
            </div>
            
            <div class="user-credentials" id="returningUser">
                <h4>Welcome Back!</h4>
                <input type="text" id="returningUserId" class="credential-field" placeholder="Your User ID">
                <input type="password" id="returningPassword" class="credential-field" placeholder="Your Password">
                <button class="consent-button" id="loginButton">Sign In</button>
                <small>Forgot your credentials? You can start fresh with "Private Sessions"</small>
            </div>
            
            <div>
                <button class="consent-button" id="proceedButton" disabled>Begin Session</button>
                <button class="consent-button" id="returningUserButton">Returning User</button>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>Agentic Therapy AI</h1>
                <p>Advanced Mental Health Support</p>
                <div id="sessionInfo">
                    <small>Session: <span id="sessionId">Loading...</span></small>
                    <div class="agentic-indicator" id="agenticIndicator">
                        <span id="modeIndicator">Checking mode...</span>
                    </div>
                </div>
            </div>

            <div class="sidebar-content">
                <!-- Agentic Features -->
                <div class="section" id="agenticFeaturesSection" style="display: none;">
                    <h3>Goals & Progress</h3>
                    <div class="goals-panel" id="goalsPanel">
                        <p>No goals set yet</p>
                    </div>
                    <button class="button-sidebar" id="createGoalBtn">Create Goal</button>
                    <button class="button-sidebar" id="viewDashboardBtn">View Dashboard</button>
                </div>

                <!-- Goal Creation Form -->
                <div class="section" id="goalCreationSection" style="display: none;">
                    <h3>Create New Goal</h3>
                    <input type="text" id="goalTitle" class="input-field-sidebar" placeholder="Goal title (e.g., Manage anxiety)">
                    <textarea id="goalDescription" class="input-field-sidebar" rows="3" placeholder="Describe your goal in detail..."></textarea>
                    <select id="goalDuration" class="select-field">
                        <option value="7">1 Week</option>
                        <option value="14">2 Weeks</option>
                        <option value="30" selected>1 Month</option>
                        <option value="60">2 Months</option>
                        <option value="90">3 Months</option>
                    </select>
                    <button class="button-sidebar" id="saveGoalBtn">Save Goal</button>
                    <button class="button-sidebar" id="cancelGoalBtn">Cancel</button>
                </div>

                <!-- User Management -->
                <div class="section" id="userManagementSection" style="display: none;">
                    <h3>Account Management</h3>
                    <button class="button-sidebar" id="deleteDataBtn" style="background: var(--gradient-medium);">Delete All Data</button>
                    <button class="button-sidebar" id="switchModeBtn">Switch to Private Mode</button>
                </div>

                <!-- Voice Controls -->
                <div class="section" id="voiceControlsSection">
                    <h3>Voice Features</h3>
                    <div class="voice-status" id="voiceStatus">
                        <div>
                            <span class="status-dot unknown"></span>
                            <span>Checking voice system...</span>
                        </div>
                    </div>
                    <button class="button-sidebar" id="voiceToggleBtn" disabled>üé§ Enable Voice</button>
                    <button class="button-sidebar" id="listenBtn" disabled>üéØ Listen Now</button>
                    <small id="voiceInstructions">Enable voice features for speech input and audio responses</small>
                </div>

                <!-- Video Controls -->
                <div class="section" id="videoControlsSection">
                    <h3>Video Features</h3>
                    <div class="video-status" id="videoStatus">
                        <div>
                            <span class="status-dot unknown"></span>
                            <span>Checking video system...</span>
                        </div>
                    </div>
                    <button class="button-sidebar" id="videoToggleBtn" disabled>üìπ Enable Video</button>
                    <button class="button-sidebar" id="analyzeVideoBtn" disabled>üìä Analyze Emotion</button>

                    <!-- Video stream display -->
                    <div class="video-stream-container" id="videoStreamContainer" style="display: none;">
                        <video id="videoStream" width="320" height="240" autoplay muted style="border: 2px solid var(--border-light); border-radius: var(--radius-md); background: #000;"></video>
                    </div>

                    <!-- Video emotion display -->
                    <div class="video-emotion-display" id="videoEmotionDisplay" style="display: none;">
                        <div class="emotion-indicator">
                            <span class="emotion-emoji" id="emotionEmoji">üòê</span>
                            <span class="emotion-text" id="emotionText">Neutral</span>
                            <span class="emotion-confidence" id="emotionConfidence">0%</span>
                        </div>
                    </div>

                    <small id="videoInstructions">Enable video for facial expression analysis</small>
                </div>

                <!-- Analysis Settings -->
                <div class="section">
                    <h3>Analysis Settings</h3>
                    <label>Crisis Detection:</label>
                    <select class="select-field" id="crisisSensitivity">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                    
                    <label>Analysis Depth:</label>
                    <select class="select-field" id="analysisDepth">
                        <option value="basic">Basic</option>
                        <option value="standard" selected>Standard</option>
                        <option value="comprehensive">Comprehensive</option>
                    </select>
                </div>

                <!-- Provider Status -->
                <div class="section">
                    <h3>System Status</h3>
                    <div class="provider-status" id="providerStatus">
                        <div>
                            <span class="status-dot unknown"></span>
                            <span>Checking providers...</span>
                        </div>
                    </div>
                </div>

                <!-- Session Statistics -->
                <div class="section" id="sessionStats">
                    <h3>Session Overview</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="messageCount">0</div>
                            <div class="stat-label">Messages</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="sessionDuration">0m</div>
                            <div class="stat-label">Duration</div>
                        </div>
                    </div>
                    <div id="emotionalTrend"></div>
                </div>

                <!-- Dashboard Insights -->
                <div class="section" id="dashboardSection" style="display: none;">
                    <h3>Insights</h3>
                    <div class="dashboard-panel" id="dashboardPanel">
                        <p>Loading insights...</p>
                    </div>
                </div>

                <!-- Emergency Resources -->
                <div class="emergency-resources">
                    <h4>Emergency Resources</h4>
                    <ul>
                        <li>988 - Crisis Lifeline</li>
                        <li>741741 - Crisis Text</li>
                        <li>911 - Emergency</li>
                    </ul>
                </div>

                <button class="button-sidebar" id="resetSession" style="margin-top: 15px;">
                    New Session
                </button>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-area">
            <div class="chat-header">
                <h2>Therapy Chat Session</h2>
                <p>Share what's on your mind - I'm here to provide personalized support</p>
            </div>

            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <!-- Messages will be added here -->
                </div>

                <!-- Loading indicator -->
                <div class="loading" id="loadingIndicator">
                    <div class="spinner"></div>
                    <p>Thinking...</p>
                </div>

                <!-- Input Area -->
                <div class="input-area">
                    <!-- Multimodal Controls -->
                    <div class="multimodal-controls">
                        <label class="multimodal-toggle" id="voiceToggle">
                            <input type="checkbox" id="includeVoice">
                            <span>üé§ Voice Response</span>
                        </label>
                        <label class="multimodal-toggle" id="videoToggle">
                            <input type="checkbox" id="includeVideo">
                            <span>üìπ Video Analysis</span>
                        </label>
                    </div>

                    <div class="input-container">
                        <button id="voiceInputBtn" class="voice-input-btn" disabled title="Voice Input">
                            üé§
                        </button>
                        <textarea
                            id="messageInput"
                            class="input-field"
                            placeholder="Share your thoughts and feelings... or click the mic for voice input"
                            rows="1"
                        ></textarea>
                        <button id="sendButton" class="send-button">
                            <span>Send</span>
                            <span>‚û§</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Agentic Therapy AI - Enhanced Mental Health Support Application
        // JavaScript functionality for advanced AI therapy with agentic capabilities

        // Application state management
        let appState = {
            sessionId: null,
            chatHistory: [],
            settings: {
                crisis_sensitivity: 'medium',
                analysis_depth: 'standard'
            },
            sessionStartTime: null,
            agenticMode: false,
            userId: null,
            currentGoals: [],
            // Multimodal features
            voiceEnabled: false,
            videoEnabled: false,
            voiceAvailable: false,
            videoAvailable: false,
            isListening: false,
            isAnalyzing: false
        };

        // Initialize application when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Agentic Therapy AI initializing...');
            initializeApp();
        });

        /**
         * Initialize the application
         */
        async function initializeApp() {
            try {
                setupEventListeners();
                await createNewSession();
                await checkProviderStatus();
                await initializeMultimodalFeatures();
                showPrivacyConsent();
                console.log('Agentic Therapy AI initialized successfully');
            } catch (error) {
                console.error('Failed to initialize Agentic Therapy AI:', error);
                showError('Failed to initialize the application. Please refresh the page.');
            }
        }

        /**
         * Set up event listeners for user interactions
         */
        function setupEventListeners() {
            // Privacy consent handling
            const privateOption = document.getElementById('privateOption');
            const agenticOption = document.getElementById('agenticOption');
            const proceedButton = document.getElementById('proceedButton');
            const returningUserButton = document.getElementById('returningUserButton');
            const loginButton = document.getElementById('loginButton');
            
            privateOption.addEventListener('click', () => selectPrivacyOption('private'));
            agenticOption.addEventListener('click', () => selectPrivacyOption('agentic'));
            proceedButton.addEventListener('click', handlePrivacyConsent);
            returningUserButton.addEventListener('click', showReturningUserForm);
            loginButton.addEventListener('click', handleReturningUser);

            // Chat functionality
            const sendButton = document.getElementById('sendButton');
            const messageInput = document.getElementById('messageInput');
            
            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Auto-resize textarea
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // Settings management
            const crisisSensitivity = document.getElementById('crisisSensitivity');
            const analysisDepth = document.getElementById('analysisDepth');
            
            crisisSensitivity.addEventListener('change', (e) => updateSetting('crisis_sensitivity', e.target.value));
            analysisDepth.addEventListener('change', (e) => updateSetting('analysis_depth', e.target.value));

            // Agentic features
            const createGoalBtn = document.getElementById('createGoalBtn');
            const saveGoalBtn = document.getElementById('saveGoalBtn');
            const cancelGoalBtn = document.getElementById('cancelGoalBtn');
            const viewDashboardBtn = document.getElementById('viewDashboardBtn');
            const deleteDataBtn = document.getElementById('deleteDataBtn');
            const switchModeBtn = document.getElementById('switchModeBtn');

            createGoalBtn.addEventListener('click', showGoalCreation);
            saveGoalBtn.addEventListener('click', saveGoal);
            cancelGoalBtn.addEventListener('click', hideGoalCreation);
            viewDashboardBtn.addEventListener('click', toggleDashboard);
            deleteDataBtn.addEventListener('click', deleteAllUserData);
            switchModeBtn.addEventListener('click', switchToPrivateMode);

            // Session management
            const resetButton = document.getElementById('resetSession');
            resetButton.addEventListener('click', resetSession);

            // Voice and Video controls
            const voiceToggleBtn = document.getElementById('voiceToggleBtn');
            const videoToggleBtn = document.getElementById('videoToggleBtn');
            const listenBtn = document.getElementById('listenBtn');
            const analyzeVideoBtn = document.getElementById('analyzeVideoBtn');
            const voiceInputBtn = document.getElementById('voiceInputBtn');
            const voiceToggle = document.getElementById('voiceToggle');
            const videoToggle = document.getElementById('videoToggle');

            voiceToggleBtn.addEventListener('click', toggleVoiceSystem);
            videoToggleBtn.addEventListener('click', toggleVideoSystem);
            listenBtn.addEventListener('click', startVoiceInput);
            analyzeVideoBtn.addEventListener('click', analyzeVideoEmotion);
            voiceInputBtn.addEventListener('click', startVoiceInput);
            voiceToggle.addEventListener('change', toggleVoiceResponse);
            videoToggle.addEventListener('change', toggleVideoAnalysis);
        }

        /**
         * Show privacy consent interface
         */
        function showPrivacyConsent() {
            document.getElementById('privacyOverlay').style.display = 'flex';
        }

        /**
         * Handle privacy option selection
         */
        function selectPrivacyOption(option) {
            const privateOption = document.getElementById('privateOption');
            const agenticOption = document.getElementById('agenticOption');
            const retentionSelector = document.getElementById('retentionSelector');
            const userCredentials = document.getElementById('userCredentials');
            const proceedButton = document.getElementById('proceedButton');

            // Reset selections
            privateOption.classList.remove('selected');
            agenticOption.classList.remove('selected');
            retentionSelector.classList.remove('show');
            userCredentials.classList.remove('show');

            if (option === 'private') {
                privateOption.classList.add('selected');
                proceedButton.disabled = false;
                appState.agenticMode = false;
            } else if (option === 'agentic') {
                agenticOption.classList.add('selected');
                retentionSelector.classList.add('show');
                userCredentials.classList.add('show');
                proceedButton.disabled = false;
                appState.agenticMode = true;
            }
        }

        /**
         * Show returning user form
         */
        function showReturningUserForm() {
            document.getElementById('userCredentials').classList.remove('show');
            document.getElementById('returningUser').classList.add('show');
        }

        /**
         * Handle returning user authentication
         */
        async function handleReturningUser() {
            const userId = document.getElementById('returningUserId').value.trim();
            const password = document.getElementById('returningPassword').value.trim();

            if (!userId || !password) {
                alert('Please enter both User ID and password.');
                return;
            }

            try {
                const response = await fetch('/api/user/authenticate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: appState.sessionId,
                        user_id: userId,
                        password: password
                    })
                });

                const data = await response.json();

                if (data.success) {
                    appState.agenticMode = true;
                    appState.userId = userId;
                    document.getElementById('privacyOverlay').style.display = 'none';
                    
                    updateModeIndicator();
                    showAgenticFeatures();
                    addWelcomeMessage(true, data.auth_result);
                    
                    // Load user goals and dashboard
                    await loadUserGoals();
                    
                    setTimeout(() => {
                        document.getElementById('messageInput').focus();
                    }, 500);
                } else {
                    alert('Authentication failed: ' + data.auth_result?.message || 'Invalid credentials');
                }
            } catch (error) {
                console.error('Authentication error:', error);
                alert('Authentication failed. Please check your connection and try again.');
            }
        }

        /**
         * Handle privacy consent decision
         */
        async function handlePrivacyConsent() {
            let userChoice = {};

            if (appState.agenticMode) {
                const preferredName = document.getElementById('preferredName').value.trim();
                const password = document.getElementById('userPassword').value.trim();
                const retentionDays = parseInt(document.getElementById('retentionDays').value);

                if (!preferredName || !password) {
                    alert('Please fill in your name and create a password for agentic mode.');
                    return;
                }

                userChoice = {
                    choice: 'remember',
                    retention_days: retentionDays,
                    preferred_name: preferredName,
                    password: password
                };
            } else {
                userChoice = {
                    choice: 'private'
                };
            }

            try {
                // First request privacy consent
                const consentResponse = await fetch('/api/privacy/consent/request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: appState.sessionId
                    })
                });

                if (!consentResponse.ok) {
                    throw new Error('Failed to request consent');
                }

                // Then handle the user's choice
                const response = await fetch('/api/privacy/consent/respond', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: appState.sessionId,
                        user_choice: userChoice
                    })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('privacyOverlay').style.display = 'none';
                    
                    if (data.agentic_mode) {
                        appState.userId = data.consent_result?.user_id;
                        showAgenticFeatures();
                        
                        // Show user credentials for first-time users
                        if (data.consent_result?.user_id && data.consent_result?.password) {
                            showUserCredentials(data.consent_result);
                        }
                    }
                    
                    updateModeIndicator();
                    addWelcomeMessage(data.agentic_mode);
                    
                    setTimeout(() => {
                        document.getElementById('messageInput').focus();
                    }, 500);
                } else {
                    throw new Error(data.error || 'Failed to process consent');
                }
            } catch (error) {
                console.error('Error processing consent:', error);
                alert('Failed to process your choice. Please try again.');
            }
        }

        /**
         * Show user credentials for safekeeping
         */
        function showUserCredentials(credentials) {
            const message = `Please save these credentials securely:

User ID: ${credentials.user_id}
Password: ${credentials.password}

You'll need these to access your data in future sessions. This information cannot be recovered if lost.`;
            
            alert(message);
        }

        /**
         * Update mode indicator in sidebar
         */
        function updateModeIndicator() {
            const indicator = document.getElementById('modeIndicator');
            if (appState.agenticMode) {
                indicator.textContent = 'Agentic Mode: Learning & Remembering';
                indicator.style.background = 'rgba(0, 0, 0, 0.2)';
            } else {
                indicator.textContent = 'Private Mode: No Memory';
                indicator.style.background = 'rgba(255, 255, 255, 0.1)';
            }
        }

        /**
         * Show agentic features in sidebar
         */
        function showAgenticFeatures() {
            document.getElementById('agenticFeaturesSection').style.display = 'block';
            document.getElementById('userManagementSection').style.display = 'block';
        }

        /**
         * Create a new therapy session
         */
        async function createNewSession() {
            try {
                const response = await fetch('/api/session/new', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    appState.sessionId = data.session_id;
                    appState.sessionStartTime = new Date();
                    
                    const sessionIdElement = document.getElementById('sessionId');
                    sessionIdElement.textContent = data.session_id.substring(0, 8) + '...';
                    
                    console.log('New session created:', data.session_id);
                } else {
                    throw new Error(data.error || 'Failed to create session');
                }
            } catch (error) {
                console.error('Error creating session:', error);
                showError('Failed to create session. Please refresh the page and try again.');
            }
        }

        /**
         * Check the status of AI providers
         */
        async function checkProviderStatus() {
            try {
                const response = await fetch('/api/providers/status');
                const data = await response.json();
                
                if (data.success) {
                    updateProviderStatus(data.status);
                }
            } catch (error) {
                console.error('Error checking provider status:', error);
                updateProviderStatus({ primary: 'fallback' });
            }
        }

        /**
         * Update provider status display
         */
        function updateProviderStatus(status) {
            const statusDiv = document.getElementById('providerStatus');
            const primary = status.primary;
            const agenticAvailable = status.agentic_available;
            
            let statusText = '';
            let statusClass = 'unknown';
            
            switch (primary) {
                case 'ollama':
                    statusText = 'Ollama (Local AI)';
                    statusClass = 'online';
                    break;
                case 'groq':
                    statusText = 'Groq (Cloud AI)';
                    statusClass = 'online';
                    break;
                default:
                    statusText = 'Rule-based (Fallback)';
                    statusClass = 'offline';
            }
            
            statusDiv.innerHTML = `
                <div>
                    <span class="status-dot ${statusClass}"></span>
                    <span>${statusText}</span>
                </div>
                <div style="margin-top: 5px; font-size: 0.8em;">
                    Agentic: ${agenticAvailable ? 'Available' : 'Limited'}
                </div>
            `;
        }

        /**
         * Add welcome message to start the therapy session
         */
        function addWelcomeMessage(agenticMode = false, authResult = null) {
            let welcomeContent = '';
            
            if (agenticMode && authResult?.proactive_checkin) {
                welcomeContent = authResult.checkin_message || "Welcome back! I'm glad to continue our therapeutic journey together.";
            } else if (agenticMode) {
                welcomeContent = "Welcome to Agentic Therapy AI! I'm excited to work with you on your mental health journey.\n\nIn this mode, I can remember our conversations, help you set and track therapeutic goals, and provide personalized insights based on our interactions over time. I'll learn what techniques work best for you and can even check in proactively when appropriate.\n\nWhat would you like to focus on today? We could set a therapeutic goal, discuss what's on your mind, or continue working on something we've talked about before.";
            } else {
                welcomeContent = "Hello, and welcome to Therapy AI. I'm here to provide compassionate mental health support through our conversation.\n\nI use evidence-based therapeutic techniques and can help you process your thoughts and feelings in a safe, judgment-free space. Please feel free to share what's on your mind.\n\nRemember, while I'm here to support you, I'm an AI assistant and not a replacement for professional therapy. If you're experiencing a crisis, please reach out to emergency services or a crisis hotline.\n\nWhat would you like to talk about today?";
            }

            const welcomeMsg = {
                role: 'assistant',
                content: welcomeContent,
                timestamp: new Date().toISOString(),
                provider: 'System',
                personalized: agenticMode
            };
            
            addMessage(welcomeMsg);
        }

        /**
         * Send user message and get AI response
         */
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) {
                messageInput.focus();
                return;
            }

            // Disable input while processing
            const sendButton = document.getElementById('sendButton');
            messageInput.disabled = true;
            sendButton.disabled = true;

            // Clear input and reset height
            messageInput.value = '';
            messageInput.style.height = 'auto';

            // Add user message to chat
            const userMsg = {
                role: 'user',
                content: message,
                timestamp: new Date().toISOString()
            };
            
            addMessage(userMsg);
            appState.chatHistory.push(userMsg);

            // Show loading indicator
            showLoading(true);

            try {
                const response = await fetch('/api/chat/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: appState.sessionId,
                        message: message,
                        settings: appState.settings
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    const assistantMsg = data.assistant_response;
                    addMessage(assistantMsg, data.agentic_features);
                    appState.chatHistory.push(assistantMsg);
                    
                    // Show analysis if available
                    if (data.analysis) {
                        showAnalysis(data.analysis);
                    }
                    
                    // Handle crisis detection
                    if (data.crisis_detected) {
                        showCrisisAlert(data.analysis);
                    }
                    
                    // Update session stats
                    if (data.session_stats) {
                        updateSessionStats(data.session_stats);
                    }
                    
                    // Update agentic features if available
                    if (data.agentic_mode) {
                        await loadUserGoals();
                    }
                    
                } else {
                    throw new Error(data.error || 'Failed to process message');
                }

            } catch (error) {
                console.error('Error sending message:', error);
                
                const fallbackMsg = {
                    role: 'assistant',
                    content: 'I apologize, but I encountered a technical difficulty processing your message. Please try again in a moment.\n\nIf the problem persists, you might want to refresh the page or reach out to a human counselor for immediate support. Your wellbeing is important.',
                    timestamp: new Date().toISOString(),
                    provider: 'System'
                };
                
                addMessage(fallbackMsg);
                showError('Connection error. Please check your internet connection and try again.');
            } finally {
                showLoading(false);
                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.focus();
            }
        }

        /**
         * Add message to chat interface
         */
        function addMessage(message, agenticFeatures = null) {
            const chatMessages = document.getElementById('chatMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.role} fade-in`;
            
            // Add agentic styling if personalized
            if (message.personalized || agenticFeatures) {
                messageDiv.classList.add('agentic');
            }
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            avatarDiv.textContent = message.role === 'user' ? 'You' : (message.personalized ? 'AI+' : 'AI');
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const messageText = document.createElement('div');
            messageText.innerHTML = message.content.replace(/\n/g, '<br>');
            contentDiv.appendChild(messageText);
            
            // Add agentic features if available
            if (agenticFeatures) {
                const featuresDiv = document.createElement('div');
                featuresDiv.className = 'agentic-features';
                
                if (agenticFeatures.goal_progress) {
                    const progressDiv = document.createElement('div');
                    progressDiv.className = 'goal-progress';
                    const progress = agenticFeatures.goal_progress;
                    
                    progressDiv.innerHTML = `
                        <strong>Goal Progress: ${progress.goal_title}</strong>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress.progress_percentage}%"></div>
                        </div>
                        <small>${progress.progress_percentage}% complete ‚Ä¢ ${progress.encouragement}</small>
                    `;
                    featuresDiv.appendChild(progressDiv);
                }
                
                if (agenticFeatures.proactive_suggestion) {
                    const suggestionDiv = document.createElement('div');
                    suggestionDiv.className = 'proactive-suggestion';
                    suggestionDiv.textContent = agenticFeatures.proactive_suggestion;
                    featuresDiv.appendChild(suggestionDiv);
                }
                
                contentDiv.appendChild(featuresDiv);
            }
            
            const metaDiv = document.createElement('div');
            metaDiv.className = 'message-meta';
            const time = new Date(message.timestamp).toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit'
            });
            metaDiv.textContent = `‚è∞ ${time}`;
            
            if (message.provider) {
                metaDiv.textContent += ` ‚Ä¢ ${message.provider}`;
            }
            
            if (message.technique) {
                metaDiv.textContent += ` ‚Ä¢ ${message.technique}`;
            }
            
            if (message.personalized) {
                metaDiv.textContent += ' ‚Ä¢ Personalized';
            }
            
            contentDiv.appendChild(metaDiv);
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            
            chatMessages.appendChild(messageDiv);
            
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }

        /**
         * Show analysis panel for user message
         */
        function showAnalysis(analysis) {
            const messages = document.querySelectorAll('.message.user');
            const lastMessage = messages[messages.length - 1];
            
            if (lastMessage && !lastMessage.querySelector('.analysis-panel')) {
                const analysisDiv = document.createElement('div');
                analysisDiv.className = 'analysis-panel fade-in';
                
                const emotion = analysis.dominant_emotion || 'neutral';
                const sentiment = analysis.sentiment || 'neutral';
                const crisisLevel = Math.round((analysis.crisis_level || 0) * 100);
                
                let metricsHTML = `
                    <div class="analysis-metrics">
                        <div class="metric">
                            <div class="metric-value">${emotion}</div>
                            <div class="metric-label">Emotion</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${sentiment}</div>
                            <div class="metric-label">Sentiment</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${crisisLevel}%</div>
                            <div class="metric-label">Crisis Risk</div>
                        </div>
                    </div>
                `;
                
                if (analysis.mental_health_topics && analysis.mental_health_topics.length > 0) {
                    const topics = analysis.mental_health_topics.slice(0, 3).map(t => 
                        Array.isArray(t) ? t[0] : t
                    ).join(', ');
                    metricsHTML += `<div><strong>Topics:</strong> ${topics}</div>`;
                }
                
                if (analysis.suggested_techniques && analysis.suggested_techniques.length > 0) {
                    const techniques = analysis.suggested_techniques.slice(0, 2).join(', ');
                    metricsHTML += `<div><strong>Techniques:</strong> ${techniques}</div>`;
                }
                
                analysisDiv.innerHTML = metricsHTML;
                lastMessage.appendChild(analysisDiv);
            }
        }

        /**
         * Show crisis alert
         */
        function showCrisisAlert(analysis) {
            const chatMessages = document.getElementById('chatMessages');
            
            const alertDiv = document.createElement('div');
            alertDiv.className = 'crisis-alert fade-in';
            alertDiv.innerHTML = `
                <strong>üö® Crisis Indicators Detected</strong><br>
                Your safety and wellbeing are my priority. Please consider reaching out for immediate support:
                <br><br>
                <strong>Immediate Resources:</strong><br>
                ‚Ä¢ <strong>988</strong> - Suicide & Crisis Lifeline (24/7)<br>
                ‚Ä¢ <strong>741741</strong> - Crisis Text Line (Text HOME)<br>
                ‚Ä¢ <strong>911</strong> - Emergency services<br>
                ‚Ä¢ Reach out to a trusted friend, family member, or mental health professional<br>
                <br>
                Remember: You are not alone, and help is available. These feelings can change with proper support.
            `;
            
            chatMessages.appendChild(alertDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        /**
         * Show goal creation form
         */
        function showGoalCreation() {
            document.getElementById('agenticFeaturesSection').style.display = 'none';
            document.getElementById('goalCreationSection').style.display = 'block';
        }

        /**
         * Hide goal creation form
         */
        function hideGoalCreation() {
            document.getElementById('goalCreationSection').style.display = 'none';
            document.getElementById('agenticFeaturesSection').style.display = 'block';
        }

        /**
         * Save new goal
         */
        async function saveGoal() {
            const title = document.getElementById('goalTitle').value.trim();
            const description = document.getElementById('goalDescription').value.trim();
            const duration = parseInt(document.getElementById('goalDuration').value);

            if (!title) {
                alert('Please enter a goal title.');
                return;
            }

            try {
                const response = await fetch('/api/goals/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: appState.sessionId,
                        title: title,
                        description: description,
                        target_days: duration
                    })
                });

                const data = await response.json();

                if (data.success && data.goal_result.status === 'success') {
                    // Clear form
                    document.getElementById('goalTitle').value = '';
                    document.getElementById('goalDescription').value = '';
                    
                    hideGoalCreation();
                    await loadUserGoals();
                    
                    showSuccess('Goal created successfully!');
                } else {
                    throw new Error(data.goal_result?.error || 'Failed to create goal');
                }
            } catch (error) {
                console.error('Error creating goal:', error);
                alert('Failed to create goal: ' + error.message);
            }
        }

        /**
         * Load user goals
         */
        async function loadUserGoals() {
            if (!appState.agenticMode) return;

            try {
                const response = await fetch(`/api/goals/list?session_id=${appState.sessionId}`);
                const data = await response.json();

                if (data.success) {
                    updateGoalsPanel(data.goals);
                    appState.currentGoals = data.goals;
                }
            } catch (error) {
                console.error('Error loading goals:', error);
            }
        }

        /**
         * Update goals panel display
         */
        function updateGoalsPanel(goals) {
            const goalsPanel = document.getElementById('goalsPanel');
            
            if (goals.length === 0) {
                goalsPanel.innerHTML = '<p>No goals set yet</p>';
                return;
            }

            let goalsHTML = '';
            goals.forEach(goal => {
                goalsHTML += `
                    <div class="goal-item">
                        <h5>${goal.title}</h5>
                        <p>${goal.description}</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${goal.progress_score}%"></div>
                        </div>
                        <small>${Math.round(goal.progress_score)}% complete ‚Ä¢ Status: ${goal.status}</small>
                    </div>
                `;
            });
            
            goalsPanel.innerHTML = goalsHTML;
        }

        /**
         * Toggle dashboard display
         */
        async function toggleDashboard() {
            const dashboardSection = document.getElementById('dashboardSection');
            
            if (dashboardSection.style.display === 'none') {
                await loadDashboard();
                dashboardSection.style.display = 'block';
            } else {
                dashboardSection.style.display = 'none';
            }
        }

        /**
         * Load dashboard data
         */
        async function loadDashboard() {
            try {
                const response = await fetch(`/api/dashboard?session_id=${appState.sessionId}`);
                const data = await response.json();

                if (data.success && data.dashboard) {
                    updateDashboardPanel(data.dashboard);
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('dashboardPanel').innerHTML = '<p>Failed to load dashboard</p>';
            }
        }

        /**
         * Update dashboard panel
         */
        function updateDashboardPanel(dashboard) {
            const dashboardPanel = document.getElementById('dashboardPanel');
            
            if (dashboard.message) {
                dashboardPanel.innerHTML = `<p>${dashboard.message}</p>`;
                return;
            }

            let dashboardHTML = '';
            
            if (dashboard.insights) {
                dashboardHTML += '<h5>Recent Insights</h5>';
                dashboardHTML += `<div class="insight-item">Average session effectiveness: ${dashboard.insights.average_session_effectiveness.toFixed(1)}/10</div>`;
                
                if (dashboard.insights.most_effective_techniques.length > 0) {
                    dashboardHTML += `<div class="insight-item">Most effective techniques: ${dashboard.insights.most_effective_techniques.join(', ')}</div>`;
                }
                
                dashboardHTML += `<div class="insight-item">Progress trend: ${dashboard.insights.recent_progress}</div>`;
            }
            
            if (dashboard.suggestions && dashboard.suggestions.length > 0) {
                dashboardHTML += '<h5>Suggestions</h5>';
                dashboard.suggestions.forEach(suggestion => {
                    dashboardHTML += `<div class="insight-item">${suggestion}</div>`;
                });
            }
            
            dashboardPanel.innerHTML = dashboardHTML || '<p>No insights available yet</p>';
        }

        /**
         * Delete all user data
         */
        async function deleteAllUserData() {
            const confirmed = confirm(
                'Are you sure you want to delete ALL your data?\n\n' +
                'This will permanently remove:\n' +
                '‚Ä¢ All conversation history\n' +
                '‚Ä¢ Your therapeutic goals\n' +
                '‚Ä¢ Progress tracking\n' +
                '‚Ä¢ Personalization data\n\n' +
                'This action cannot be undone.'
            );

            if (confirmed) {
                try {
                    const response = await fetch('/api/user/delete', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            session_id: appState.sessionId
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert('All data has been permanently deleted.');
                        // Reset to private mode
                        location.reload();
                    } else {
                        throw new Error('Failed to delete data');
                    }
                } catch (error) {
                    console.error('Error deleting data:', error);
                    alert('Failed to delete data. Please try again.');
                }
            }
        }

        /**
         * Switch to private mode
         */
        function switchToPrivateMode() {
            const confirmed = confirm(
                'Switch to Private Mode?\n\n' +
                'This will:\n' +
                '‚Ä¢ Stop remembering conversations\n' +
                '‚Ä¢ Disable goal tracking\n' +
                '‚Ä¢ Keep your existing data safe\n\n' +
                'You can always return to Agentic Mode later.'
            );

            if (confirmed) {
                location.reload();
            }
        }

        /**
         * Update application setting
         */
        function updateSetting(setting, value) {
            appState.settings[setting] = value;
            updateSettings();
        }

        /**
         * Send updated settings to backend
         */
        async function updateSettings() {
            try {
                await fetch('/api/session/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: appState.sessionId,
                        settings: appState.settings
                    })
                });
            } catch (error) {
                console.error('Error updating settings:', error);
            }
        }

        // ===== MULTIMODAL FEATURES =====

        /**
         * Initialize multimodal features (voice and video)
         */
        async function initializeMultimodalFeatures() {
            console.log('Initializing multimodal features...');

            // Check voice system
            try {
                const voiceResponse = await fetch('/api/voice/status');
                const voiceData = await voiceResponse.json();

                if (voiceData.success) {
                    appState.voiceAvailable = voiceData.status.speech_recognition_available && voiceData.status.text_to_speech_available;
                    updateVoiceStatus(voiceData.status);
                    console.log('Voice system:', appState.voiceAvailable ? 'Available' : 'Unavailable');
                }
            } catch (error) {
                console.error('Error checking voice status:', error);
                updateVoiceStatus({ speech_recognition_available: false, text_to_speech_available: false });
            }

            // Check video system
            try {
                const videoResponse = await fetch('/api/video/status');
                const videoData = await videoResponse.json();

                if (videoData.success) {
                    appState.videoAvailable = videoData.status.face_detection_available && videoData.status.emotion_detection_available;
                    updateVideoStatus(videoData.status);
                    console.log('Video system:', appState.videoAvailable ? 'Available' : 'Unavailable');
                }
            } catch (error) {
                console.error('Error checking video status:', error);
                updateVideoStatus({ face_detection_available: false, emotion_detection_available: false });
            }

            // Enable controls if systems are available
            enableMultimodalControls();
        }

        /**
         * Update voice status display
         */
        function updateVoiceStatus(status) {
            const voiceStatusDiv = document.getElementById('voiceStatus');
            const voiceToggleBtn = document.getElementById('voiceToggleBtn');
            const listenBtn = document.getElementById('listenBtn');
            const voiceInputBtn = document.getElementById('voiceInputBtn');

            let statusText = '';
            let statusClass = 'unknown';

            if (status.speech_recognition_available && status.text_to_speech_available) {
                statusText = 'Voice System Ready';
                statusClass = 'online';
            } else {
                statusText = 'Voice System Unavailable';
                statusClass = 'offline';
            }

            voiceStatusDiv.innerHTML = `
                <div>
                    <span class="status-dot ${statusClass}"></span>
                    <span>${statusText}</span>
                </div>
            `;

            // Enable/disable buttons
            voiceToggleBtn.disabled = !appState.voiceAvailable;
            listenBtn.disabled = !appState.voiceEnabled;
            voiceInputBtn.disabled = !appState.voiceEnabled;
        }

        /**
         * Update video status display
         */
        function updateVideoStatus(status) {
            const videoStatusDiv = document.getElementById('videoStatus');
            const videoToggleBtn = document.getElementById('videoToggleBtn');
            const analyzeVideoBtn = document.getElementById('analyzeVideoBtn');

            let statusText = '';
            let statusClass = 'unknown';

            if (status.face_detection_available && status.emotion_detection_available) {
                statusText = 'Video System Ready';
                statusClass = 'online';
            } else {
                statusText = 'Video System Unavailable';
                statusClass = 'offline';
            }

            videoStatusDiv.innerHTML = `
                <div>
                    <span class="status-dot ${statusClass}"></span>
                    <span>${statusText}</span>
                </div>
            `;

            // Enable/disable buttons
            videoToggleBtn.disabled = !appState.videoAvailable;
            analyzeVideoBtn.disabled = !appState.videoEnabled;
        }

        /**
         * Enable multimodal controls
         */
        function enableMultimodalControls() {
            const voiceToggle = document.getElementById('voiceToggle');
            const videoToggle = document.getElementById('videoToggle');

            if (appState.voiceAvailable) {
                voiceToggle.style.display = 'flex';
            }

            if (appState.videoAvailable) {
                videoToggle.style.display = 'flex';
            }
        }

        /**
         * Toggle voice system on/off
         */
        async function toggleVoiceSystem() {
            const voiceToggleBtn = document.getElementById('voiceToggleBtn');

            if (appState.voiceEnabled) {
                // Disable voice
                appState.voiceEnabled = false;
                voiceToggleBtn.textContent = 'üé§ Enable Voice';
                voiceToggleBtn.classList.remove('voice-active');

                document.getElementById('listenBtn').disabled = true;
                document.getElementById('voiceInputBtn').disabled = true;
                document.getElementById('voiceInstructions').textContent = 'Enable voice features for speech input and audio responses';
            } else {
                // Enable voice
                appState.voiceEnabled = true;
                voiceToggleBtn.textContent = 'üîá Disable Voice';
                voiceToggleBtn.classList.add('voice-active');

                document.getElementById('listenBtn').disabled = false;
                document.getElementById('voiceInputBtn').disabled = false;
                document.getElementById('voiceInstructions').textContent = 'Voice system active - use microphone button or "Listen Now"';
            }
        }

        /**
         * Toggle video system on/off
         */
        async function toggleVideoSystem() {
            const videoToggleBtn = document.getElementById('videoToggleBtn');

            if (appState.videoEnabled) {
                // Disable video
                try {
                    await fetch('/api/video/stop', { method: 'POST' });
                } catch (error) {
                    console.error('Error stopping video:', error);
                }

                appState.videoEnabled = false;
                videoToggleBtn.textContent = 'üìπ Enable Video';
                videoToggleBtn.classList.remove('video-active');

                document.getElementById('analyzeVideoBtn').disabled = true;
                document.getElementById('videoEmotionDisplay').style.display = 'none';
                document.getElementById('videoStreamContainer').style.display = 'none';
                document.getElementById('videoInstructions').textContent = 'Enable video for facial expression analysis';

                // Stop camera stream
                stopVideoStream();
            } else {
                // Enable video
                try {
                    const response = await fetch('/api/video/start', { method: 'POST' });
                    const data = await response.json();

                    if (data.success) {
                        appState.videoEnabled = true;
                        videoToggleBtn.textContent = 'üö´ Disable Video';
                        videoToggleBtn.classList.add('video-active');

                        document.getElementById('analyzeVideoBtn').disabled = false;
                        document.getElementById('videoInstructions').textContent = 'Video system active - camera is running';
                        document.getElementById('videoStreamContainer').style.display = 'block';

                        // Start camera stream
                        startVideoStream();

                        showSuccess('Camera started successfully');
                    } else {
                        showError('Failed to start camera: ' + data.error);
                    }
                } catch (error) {
                    console.error('Error starting video:', error);
                    showError('Error starting camera. Please check your camera permissions.');
                }
            }
        }

        /**
         * Start voice input
         */
        async function startVoiceInput() {
            if (!appState.voiceEnabled) {
                showError('Voice system is not enabled');
                return;
            }

            const voiceInputBtn = document.getElementById('voiceInputBtn');
            const listenBtn = document.getElementById('listenBtn');

            try {
                // Set listening state
                appState.isListening = true;
                voiceInputBtn.classList.add('listening');
                listenBtn.classList.add('listening');
                listenBtn.textContent = 'üéØ Listening...';

                // Start listening
                const response = await fetch('/api/voice/listen', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                const data = await response.json();

                if (data.success && data.text) {
                    // Put recognized text in input field
                    const messageInput = document.getElementById('messageInput');
                    messageInput.value = data.text;
                    messageInput.focus();

                    showSuccess('Voice input recognized: "' + data.text.substring(0, 50) + '..."');

                    // Optionally auto-send the message
                    if (data.text.length > 5) {
                        setTimeout(() => {
                            sendMessage(true); // true indicates voice input
                        }, 500);
                    }
                } else {
                    showError('Could not understand speech: ' + (data.error || 'Unknown error'));
                }

            } catch (error) {
                console.error('Error in voice input:', error);
                showError('Voice input failed. Please try again.');
            } finally {
                // Reset listening state
                appState.isListening = false;
                voiceInputBtn.classList.remove('listening');
                listenBtn.classList.remove('listening');
                listenBtn.textContent = 'üéØ Listen Now';
            }
        }

        /**
         * Analyze video emotion
         */
        async function analyzeVideoEmotion() {
            if (!appState.videoEnabled) {
                showError('Video system is not enabled');
                return;
            }

            const analyzeVideoBtn = document.getElementById('analyzeVideoBtn');

            try {
                // Set analyzing state
                appState.isAnalyzing = true;
                analyzeVideoBtn.classList.add('analyzing');
                analyzeVideoBtn.textContent = 'üìä Analyzing...';

                // Analyze current frame
                const response = await fetch('/api/video/analyze', { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    updateVideoEmotionDisplay(data);
                    showSuccess(`Detected emotion: ${data.dominant_emotion} (${Math.round(data.confidence * 100)}% confidence)`);
                } else {
                    showError('Video analysis failed: ' + data.error);
                }

            } catch (error) {
                console.error('Error in video analysis:', error);
                showError('Video analysis failed. Please try again.');
            } finally {
                // Reset analyzing state
                appState.isAnalyzing = false;
                analyzeVideoBtn.classList.remove('analyzing');
                analyzeVideoBtn.textContent = 'üìä Analyze Emotion';
            }
        }

        /**
         * Update video emotion display
         */
        function updateVideoEmotionDisplay(analysisData) {
            const emotionDisplay = document.getElementById('videoEmotionDisplay');
            const emotionEmoji = document.getElementById('emotionEmoji');
            const emotionText = document.getElementById('emotionText');
            const emotionConfidence = document.getElementById('emotionConfidence');

            const emotion = analysisData.dominant_emotion || 'neutral';
            const confidence = Math.round((analysisData.confidence || 0) * 100);

            // Emotion to emoji mapping
            const emojiMap = {
                'happy': 'üòä',
                'sad': 'üò¢',
                'angry': 'üò†',
                'fear': 'üò∞',
                'surprise': 'üò≤',
                'disgust': 'ü§¢',
                'neutral': 'üòê'
            };

            emotionEmoji.textContent = emojiMap[emotion] || 'üòê';
            emotionText.textContent = emotion.charAt(0).toUpperCase() + emotion.slice(1);
            emotionConfidence.textContent = `${confidence}%`;

            emotionDisplay.style.display = 'block';

            // Add therapeutic suggestion if available
            if (analysisData.therapeutic_suggestion) {
                setTimeout(() => {
                    showInfo('Suggestion: ' + analysisData.therapeutic_suggestion);
                }, 1000);
            }
        }

        /**
         * Toggle voice response in messages
         */
        function toggleVoiceResponse(event) {
            const voiceToggle = document.getElementById('voiceToggle');
            if (event.target.checked) {
                voiceToggle.classList.add('active');
            } else {
                voiceToggle.classList.remove('active');
            }
        }

        /**
         * Toggle video analysis in messages
         */
        function toggleVideoAnalysis(event) {
            const videoToggle = document.getElementById('videoToggle');
            if (event.target.checked) {
                videoToggle.classList.add('active');
            } else {
                videoToggle.classList.remove('active');
            }
        }

        /**
         * Start video stream display
         */
        async function startVideoStream() {
            try {
                const videoElement = document.getElementById('videoStream');

                // Request camera access
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: 320,
                        height: 240,
                        facingMode: 'user'
                    }
                });

                videoElement.srcObject = stream;
                console.log('Video stream started successfully');

            } catch (error) {
                console.error('Error starting video stream:', error);
                showError('Unable to access camera. Please check permissions.');
            }
        }

        /**
         * Stop video stream display
         */
        function stopVideoStream() {
            try {
                const videoElement = document.getElementById('videoStream');
                const stream = videoElement.srcObject;

                if (stream) {
                    const tracks = stream.getTracks();
                    tracks.forEach(track => track.stop());
                    videoElement.srcObject = null;
                    console.log('Video stream stopped');
                }
            } catch (error) {
                console.error('Error stopping video stream:', error);
            }
        }

        /**
         * Enhanced send message function with multimodal support
         */
        async function sendMessageMultimodal(voiceInput = false) {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            const includeVoice = document.getElementById('includeVoice').checked;
            const includeVideo = document.getElementById('includeVideo').checked;

            if (!message) {
                messageInput.focus();
                return;
            }

            // Disable input while processing
            const sendButton = document.getElementById('sendButton');
            messageInput.disabled = true;
            sendButton.disabled = true;

            // Clear input and reset height
            messageInput.value = '';
            messageInput.style.height = 'auto';

            // Add user message to chat
            const userMsg = {
                role: 'user',
                content: message,
                timestamp: new Date().toISOString(),
                multimodal: {
                    voice_input: voiceInput,
                    video_analysis: includeVideo
                }
            };

            addMessage(userMsg);
            appState.chatHistory.push(userMsg);

            // Show loading indicator
            showLoading(true);

            try {
                const response = await fetch('/api/chat/multimodal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: appState.sessionId,
                        message: message,
                        include_voice: includeVoice,
                        include_video: includeVideo,
                        settings: appState.settings
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const assistantMsg = data.assistant_response;
                    addMessage(assistantMsg, data.multimodal_features);
                    appState.chatHistory.push(assistantMsg);

                    // Show analysis if available
                    if (data.analysis) {
                        showAnalysis(data.analysis);
                    }

                    // Handle crisis detection
                    if (data.crisis_detected) {
                        showCrisisAlert(data.analysis);
                    }

                    // Update session stats
                    if (data.session_stats) {
                        updateSessionStats(data.session_stats);
                    }

                    // Update video emotion display if analysis was done
                    if (data.multimodal_features?.video_emotion) {
                        updateVideoEmotionDisplay(data.multimodal_features.video_emotion);
                    }

                    // Show voice synthesis feedback
                    if (data.multimodal_features?.voice_synthesis?.speech_generated) {
                        showInfo('üîä AI response is being spoken');
                    }

                } else {
                    throw new Error(data.error || 'Failed to process message');
                }

            } catch (error) {
                console.error('Error sending multimodal message:', error);

                const fallbackMsg = {
                    role: 'assistant',
                    content: 'I apologize, but I encountered a technical difficulty processing your message. Please try again in a moment.',
                    timestamp: new Date().toISOString(),
                    provider: 'System'
                };

                addMessage(fallbackMsg);
                showError('Connection error. Please check your internet connection and try again.');
            } finally {
                showLoading(false);
                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.focus();
            }
        }

        // Update original sendMessage to use multimodal version
        async function sendMessage(voiceInput = false) {
            // Check if multimodal features are being used
            const includeVoice = document.getElementById('includeVoice').checked;
            const includeVideo = document.getElementById('includeVideo').checked;

            if (includeVoice || includeVideo) {
                return sendMessageMultimodal(voiceInput);
            } else {
                return sendMessageOriginal();
            }
        }

        // Rename original function
        async function sendMessageOriginal() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message) {
                messageInput.focus();
                return;
            }

            // Disable input while processing
            const sendButton = document.getElementById('sendButton');
            messageInput.disabled = true;
            sendButton.disabled = true;

            // Clear input and reset height
            messageInput.value = '';
            messageInput.style.height = 'auto';

            // Add user message to chat
            const userMsg = {
                role: 'user',
                content: message,
                timestamp: new Date().toISOString()
            };

            addMessage(userMsg);
            appState.chatHistory.push(userMsg);

            // Show loading indicator
            showLoading(true);

            try {
                const response = await fetch('/api/chat/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: appState.sessionId,
                        message: message,
                        settings: appState.settings
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const assistantMsg = data.assistant_response;
                    addMessage(assistantMsg, data.agentic_features);
                    appState.chatHistory.push(assistantMsg);

                    // Show analysis if available
                    if (data.analysis) {
                        showAnalysis(data.analysis);
                    }

                    // Handle crisis detection
                    if (data.crisis_detected) {
                        showCrisisAlert(data.analysis);
                    }

                    // Update session stats
                    if (data.session_stats) {
                        updateSessionStats(data.session_stats);
                    }

                    // Update agentic features if available
                    if (data.agentic_mode) {
                        await loadUserGoals();
                    }

                } else {
                    throw new Error(data.error || 'Failed to process message');
                }

            } catch (error) {
                console.error('Error sending message:', error);

                const fallbackMsg = {
                    role: 'assistant',
                    content: 'I apologize, but I encountered a technical difficulty processing your message. Please try again in a moment.\n\nIf the problem persists, you might want to refresh the page or reach out to a human counselor for immediate support. Your wellbeing is important.',
                    timestamp: new Date().toISOString(),
                    provider: 'System'
                };

                addMessage(fallbackMsg);
                showError('Connection error. Please check your internet connection and try again.');
            } finally {
                showLoading(false);
                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.focus();
            }
        }

        /**
         * Show info message (less prominent than success/error)
         */
        function showInfo(message) {
            const infoDiv = document.createElement('div');
            infoDiv.className = 'crisis-alert fade-in';
            infoDiv.style.background = 'var(--primary-lightest)';
            infoDiv.style.color = 'var(--text-primary)';
            infoDiv.style.border = '2px solid var(--border-light)';
            infoDiv.innerHTML = `<strong>üí° ${message}</strong>`;

            const chatMessages = document.getElementById('chatMessages');
            chatMessages.appendChild(infoDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            setTimeout(() => {
                if (infoDiv.parentNode) {
                    infoDiv.remove();
                }
            }, 4000);
        }

        /**
         * Update session statistics display
         */
        function updateSessionStats(stats) {
            if (stats) {
                const messageCountElement = document.getElementById('messageCount');
                if (messageCountElement) {
                    messageCountElement.textContent = stats.message_count || appState.chatHistory.length;
                }
                
                const durationElement = document.getElementById('sessionDuration');
                if (durationElement) {
                    const duration = stats.duration_minutes || calculateSessionDuration();
                    durationElement.textContent = `${duration}m`;
                }
                
                const trendDiv = document.getElementById('emotionalTrend');
                if (trendDiv && stats.dominant_emotion && stats.dominant_emotion !== 'neutral') {
                    trendDiv.innerHTML = `<strong>Recent Emotion:</strong><br>${stats.dominant_emotion}`;
                }
            }
        }

        /**
         * Calculate session duration in minutes
         */
        function calculateSessionDuration() {
            if (!appState.sessionStartTime) return 0;
            
            const now = new Date();
            const diff = now - appState.sessionStartTime;
            return Math.floor(diff / (1000 * 60));
        }

        /**
         * Reset therapy session
         */
        async function resetSession() {
            const confirmReset = confirm(
                'Start a new session?\n\n' +
                'This will:\n' +
                '‚Ä¢ Clear current chat history\n' +
                '‚Ä¢ Reset session statistics\n' +
                '‚Ä¢ Require new consent\n' +
                (appState.agenticMode ? '‚Ä¢ Keep your saved goals and data safe\n' : '') +
                '\nContinue?'
            );
            
            if (confirmReset) {
                location.reload();
            }
        }

        /**
         * Show/hide loading indicator
         */
        function showLoading(show) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (show) {
                loadingIndicator.classList.add('show');
            } else {
                loadingIndicator.classList.remove('show');
            }
        }

        /**
         * Display error message
         */
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'crisis-alert fade-in';
            errorDiv.style.background = 'var(--gradient-medium)';
            errorDiv.innerHTML = `
                <strong>‚ö†Ô∏è Technical Issue</strong><br>
                ${message}<br><br>
                If this continues, please refresh the page or contact support.
            `;
            
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.appendChild(errorDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 10000);
        }

        /**
         * Display success message
         */
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'crisis-alert fade-in';
            successDiv.style.background = 'var(--gradient-dark)';
            successDiv.innerHTML = `<strong>‚úì ${message}</strong>`;
            
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.appendChild(successDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.remove();
                }
            }, 3000);
        }

        /**
         * Periodic updates
         */
        function startPeriodicUpdates() {
            // Update session stats every 30 seconds
            setInterval(async function() {
                if (appState.sessionId) {
                    try {
                        const response = await fetch(`/api/session/stats/${appState.sessionId}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success) {
                                updateSessionStats(data.stats);
                            }
                        }
                    } catch (error) {
                        console.error('Error updating stats:', error);
                    }
                }
            }, 30000);

            // Check provider status every minute
            setInterval(checkProviderStatus, 60000);
        }

        /**
         * Handle keyboard shortcuts
         */
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                const messageInput = document.getElementById('messageInput');
                if (messageInput === document.activeElement) {
                    sendMessage();
                }
            }
            
            if (e.key === 'Escape') {
                const messageInput = document.getElementById('messageInput');
                messageInput.focus();
            }
        });

        /**
         * Handle page visibility changes
         */
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && appState.sessionId) {
                checkProviderStatus();
                if (appState.agenticMode) {
                    loadUserGoals();
                }
            }
        });

        /**
         * Initialize periodic updaters
         */
        window.addEventListener('load', function() {
            startPeriodicUpdates();
        });

        /**
         * Handle beforeunload warning
         */
        window.addEventListener('beforeunload', function(e) {
            if (appState.chatHistory.length > 0) {
                e.preventDefault();
                e.returnValue = 'You have an active therapy session. Are you sure you want to leave?';
                return e.returnValue;
            }
        });
    </script>
</body>
</html>